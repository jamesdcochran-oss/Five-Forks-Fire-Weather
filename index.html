<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Five Forks Fire Weather ‚Äî Live</title>

    <!-- Tailwind (CDN) -->
    <script>window.tailwind = { darkMode: 'class' };</script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React / ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel (JSX in-browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts UMD (optional; app falls back if blocked) -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.min.js"></script>

    <!-- Leaflet (map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      html, body, #root { height: 100%; }
      body { margin: 0; }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      /* ------------------ Error Boundary ------------------ */
      class ErrorBoundary extends React.Component {
        constructor(p){ super(p); this.state = { error: null }; }
        static getDerivedStateFromError(error){ return { error }; }
        componentDidCatch(err, info){ console.error('ErrorBoundary:', err, info); }
        render(){
          if (this.state.error) {
            return (
              <div className="max-w-2xl mx-auto p-4 mt-6 rounded-xl border border-red-500/40 bg-red-500/10">
                <h2 className="text-red-300 font-bold mb-2">UI crashed</h2>
                <pre className="text-xs text-red-200 whitespace-pre-wrap">{String(this.state.error?.message || this.state.error)}</pre>
                <p className="text-xs text-slate-300 mt-2">Open the console for stack details. The app tries to keep going.</p>
              </div>
            );
          }
          return this.props.children;
        }
      }

      /* ------------------ Optional Recharts ------------------ */
      const R = window.Recharts ?? null;
      const hasRecharts = !!R;
      let AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend;
      if (hasRecharts) {
        ({ AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = R);
      }

      /* ------------------ Tiny UI primitives ------------------ */
      const cn = (...a) => a.filter(Boolean).join(' ');
      const Card = ({ className, children }) => (
        <div className={cn('rounded-xl border bg-slate-800/50 border-slate-700/50 backdrop-blur-sm', className)}>{children}</div>
      );
      const CardHeader = ({ className, children }) => <div className={cn('px-4 pt-4 pb-2', className)}>{children}</div>;
      const CardTitle = ({ className, children }) => <h3 className={cn('text-white font-semibold text-base', className)}>{children}</h3>;
      const CardContent = ({ className, children }) => <div className={cn('px-4 pb-4', className)}>{children}</div>;
      const Badge = ({ className, children }) => (
        <span className={cn('inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-slate-700/40 text-slate-200', className)}>{children}</span>
      );
      const Button = ({ className, children, ...props }) => (
        <button {...props} className={cn('inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 bg-orange-500 text-white hover:bg-orange-600 disabled:opacity-60', className)}>{children}</button>
      );
      const Progress = ({ value, className }) => {
        const pct = Math.max(0, Math.min(100, value ?? 0));
        return (
          <div className={cn('w-full h-2 rounded bg-slate-700/50', className)}>
            <div className="h-2 rounded bg-orange-500" style={{ width: pct + '%' }} />
          </div>
        );
      };

      /* ------------------ Diagnostics (mini-tests) ------------------ */
      function Diagnostics(){
        const splitOk = (()=>{ const s='a,b\r\nc,d'; const lines = s.trim().split(/\r?\n/); return lines.length===2; })();
        const tests = [
          { name: 'React', pass: !!window.React },
          { name: 'ReactDOM', pass: !!window.ReactDOM?.createRoot },
          { name: 'Leaflet', pass: !!window.L },
          { name: 'Recharts (optional)', pass: !!window.Recharts },
          { name: 'CSV split', pass: splitOk },
        ];
        return (
          <div className="text-xs text-slate-400 flex flex-wrap gap-2">
            {tests.map((t,i)=> (
              <span key={i} className={cn('px-2 py-1 rounded border', t.pass?'border-green-500/40 bg-green-500/10 text-green-300':'border-slate-600/40 bg-slate-700/30 text-slate-300')}>
                {t.pass?'‚úÖ':'‚ö™'} {t.name}
              </span>
            ))}
          </div>
        );
      }

      /* ------------------ Helpers ------------------ */
      const AQI_STYLES = {
        'Good': { bg: 'bg-green-500/20', text: 'text-green-400', border: 'border-green-500/30' },
        'Moderate': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', border: 'border-yellow-500/30' },
        'Unhealthy for Sensitive Groups': { bg: 'bg-orange-500/20', text: 'text-orange-400', border: 'border-orange-500/30' },
        'Unhealthy': { bg: 'bg-red-500/20', text: 'text-red-400', border: 'border-red-500/30' },
        'Very Unhealthy': { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/30' },
        'Hazardous': { bg: 'bg-red-900/30', text: 'text-red-300', border: 'border-red-800/50' },
      };
      const DANGER_STYLES = {
        'Low': 'bg-green-500/20 text-green-400 border-green-500/30',
        'Moderate': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
        'High': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
        'Very High': 'bg-red-500/20 text-red-400 border-red-500/30',
        'Extreme': 'bg-purple-500/20 text-purple-400 border-purple-500/30',
      };
      const THRESH = { tempF: 86, rh: 30, windMph: 19 }; // 30/30/30 rule ‚âà 30¬∞C (86¬∞F), 30% RH, 30 km/h (19 mph)
      const calcDanger = (h, wind, t, kbdi) => {
        const rh = typeof h === 'number' ? h : (h==null ? null : parseFloat(h));
        const ws = typeof wind === 'number' ? wind : (wind==null ? null : parseFloat(wind));
        const tf = typeof t === 'number' ? t : (t==null ? null : parseFloat(t));
        if (rh==null || ws==null || tf==null || !isFinite(rh) || !isFinite(ws) || !isFinite(tf)) {
          return { cls: '1', lvl: 'Low', css: DANGER_STYLES['Low'], icon: '‚ÑπÔ∏è' };
        }
        const tOK = tf >= THRESH.tempF;     // Temp ‚â• 86¬∞F
        const hOK = rh <= THRESH.rh;        // RH ‚â§ 30%
        const wOK = ws >= THRESH.windMph;   // Wind ‚â• 19 mph (~30 km/h)
        const passes = [tOK, hOK, wOK].filter(Boolean).length;

        if (tOK && hOK && wOK) return { cls: '5', lvl: 'Extreme',   css: DANGER_STYLES['Extreme'],   icon: 'üî•' }; // full 30/30/30
        if (passes >= 2)         return { cls: '4', lvl: 'Very High', css: DANGER_STYLES['Very High'], icon: 'üî•' }; // 30/30 crossover
        if (passes === 1)        return { cls: '3', lvl: 'High',      css: DANGER_STYLES['High'],      icon: '‚ö†Ô∏è' };
        // fallback using slightly milder thresholds
        if ((rh <= 35 && ws >= 10) || tf >= 80) return { cls: '2', lvl: 'Moderate', css: DANGER_STYLES['Moderate'], icon: '„Ä∞Ô∏è' };
        return { cls: '1', lvl: 'Low', css: DANGER_STYLES['Low'], icon: '‚úÖ' };
      };
        if (s >= 5) return { cls: '4', lvl: 'Very High', css: DANGER_STYLES['Very High'], icon: 'üî•' };
        if (s >= 3) return { cls: '3', lvl: 'High', css: DANGER_STYLES['High'], icon: '‚ö†Ô∏è' };
        if (s >= 2) return { cls: '2', lvl: 'Moderate', css: DANGER_STYLES['Moderate'], icon: '„Ä∞Ô∏è' };
        return { cls: '1', lvl: 'Low', css: DANGER_STYLES['Low'], icon: '‚úÖ' };
      };

      /* ------------------ Live Data Loader ------------------ */
      function useLiveData(){
        const [lastUpdate, setLastUpdate] = useState(new Date());
        const [isRefreshing, setIsRefreshing] = useState(false);
        const [airQualityLike, setAir] = useState(null); // derived from NWS (not true AQI)
        const [incidents, setInc] = useState([]);
        const [stations, setSta] = useState([]);
        const [fireWeather, setFW] = useState(null);
        const [drought, setDr] = useState(null);
        const [alerts, setAl] = useState([]);
        const [hotspots, setHotspots] = useState([]);

        const counties = [
          { id:'dinwiddie', name:'Dinwiddie', lat:37.02153, lon:-77.60261 },
          { id:'amelia', name:'Amelia', lat:37.32646, lon:-77.99537 },
          { id:'nottoway', name:'Nottoway', lat:37.14824, lon:-78.03382 },
          { id:'brunswick', name:'Brunswick', lat:36.78112, lon:-77.85049 },
          { id:'greensville', name:'Greensville', lat:36.64130, lon:-77.56347 },
          { id:'prince_george', name:'Prince George', lat:37.18810, lon:-77.18101 }
        ];

        const parseWind = (s)=>{ // "12 mph" or "5 to 10 mph"
          if(!s) return { speed: null, dir: null };
          const dir = /[NSEW]{1,2}/.exec(s)?.[0] || null;
          const m = s.match(/(\d+)(?=\s*mph)/);
          const speed = m? parseInt(m[1],10): null;
          return { speed, dir };
        };

        async function loadHourly(lat, lon){
          const pt = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
          if(!pt.ok) throw new Error('points');
          const grid = await pt.json();
          const url = grid?.properties?.forecastHourly;
          const r = await fetch(url, { cache:'no-store' });
          if(!r.ok) throw new Error('hourly');
          const j = await r.json();
          const p = j?.properties?.periods?.[0];
          return p || null;
        }

        const load = async()=>{
          // Alerts (VA/NC/MD filtered & prioritized for AKQ / fire weather)
          try {
            const res = await fetch('https://api.weather.gov/alerts/active?area=VA,NC,MD', { headers: { Accept: 'application/geo+json' } });
            if (res.ok) {
              const json = await res.json();
              const feats = json.features || [];
              const mapped = feats.map(f=> ({
                id: f.id,
                alert_type: f.properties?.event,
                severity: f.properties?.severity,
                headline: f.properties?.headline,
                description: f.properties?.description,
                instruction: f.properties?.instruction,
                affected_zones: f.properties?.geocode?.UGC || [],
                onset: f.properties?.onset,
                expires: f.properties?.expires,
                is_active: true,
              }));
              const prioritized = mapped.filter(a => /red flag|fire weather/i.test(a.alert_type||'') || /AKQ|Wakefield/i.test(a.headline||''));
              setAl(prioritized.length ? prioritized : mapped.slice(0,5));
            }
          } catch(e){ console.warn('NWS alerts failed', e); }

          // County conditions via NWS hourly forecast at each centroid
          try{
            const perCounty = await Promise.all(counties.map(async c=>{
              try{
                const p = await loadHourly(c.lat, c.lon);
                const { speed, dir } = parseWind(p?.windSpeed);
                return {
                  id:c.id, name:c.name, location:'VA',
                  temperature: typeof p?.temperature==='number' ? p.temperature : null,
                  humidity: Math.round(p?.relativeHumidity?.value ?? NaN),
                  wind_speed: speed, wind_gust: null, dew_point: null,
                  aqi: null, kbdi: null, last_updated: new Date().toISOString(), wind_direction: p?.windDirection || dir || null
                };
              }catch(_){
                return { id:c.id, name:c.name, location:'VA', temperature:null, humidity:null, wind_speed:null, last_updated:new Date().toISOString() };
              }
            }));
            setSta(perCounty);
            // Aggregate for summary cards
            const nums = (arr, key)=> arr.map(x=>x[key]).filter(v=> typeof v==='number' && isFinite(v));
            const avg = (a)=> a.length? Math.round(a.reduce((s,v)=>s+v,0)/a.length) : null;
            const tAvg = avg(nums(perCounty,'temperature'));
            const hAvg = avg(nums(perCounty,'humidity'));
            const wAvg = avg(nums(perCounty,'wind_speed'));
            const danger = (hAvg!=null && wAvg!=null && tAvg!=null) ?
              (hAvg<=20 && wAvg>=15? 'Very High' : (hAvg<=30 && wAvg>=10) || tAvg>=90 ? 'High' : hAvg<=40 ? 'Moderate' : 'Low') : 'Low';
            setAir({ aqi: 0, category: 'Good', pm25: 0, temperature: tAvg, humidity: hAvg, wind_speed: wAvg, wind_direction: perCounty[0]?.wind_direction || '-', fire_danger_level: danger });
          }catch(e){ console.warn('Hourly load failed', e); }

          // FIRMS hotspots (24h, bbox around region)
          try {
            const inBBox = (lat, lon, pad=2)=> lat>(37.09-pad)&&lat<(37.09+pad)&&lon>(-77.68-pad)&&lon<(-77.68+pad);
            const parseCSV=(text)=>{ const norm=text.replace(/^\uFEFF/, '').replace(/\r\n?/g,'\n').trim(); const [h,...ls]=norm.split('\n'); const keys=h.split(','); return ls.filter(Boolean).map(l=>{ const cells=l.split(','); const row={}; keys.forEach((k,i)=> row[k]=cells[i]); return row;}); };
            const sources=[
              { url:'https://firms.modaps.eosdis.nasa.gov/active_fire/c2/csv/VIIRS_C2_USA_contiguous_and_Hawaii_24h.csv', sat:'VIIRS' },
              { url:'https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/csv/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.csv', sat:'MODIS' },
            ];
            const all=[];
            for(const s of sources){
              try{ const r=await fetch(s.url,{cache:'no-store'}); if(!r.ok) continue; const txt=await r.text(); const rows=parseCSV(txt);
                rows.forEach(row=>{ const lat=+row.latitude, lon=+row.longitude; if(!isFinite(lat)||!isFinite(lon)) return; if(!inBBox(lat,lon,2)) return; const conf=(row.confidence_text||row.confidence||'').toLowerCase(); const norm=/high/.test(conf)?'high':/nominal|medium|med/.test(conf)?'nominal':'low'; all.push({ lat, lng:lon, confidence:norm, satellite:s.sat, acq_date:row.acq_date, acq_time:row.acq_time, frp: parseFloat(row.frp)||undefined}); });
              }catch(_){ /* ignore */ }
            }
            setHotspots(all);
            // naive incidents summary from hotspots
            setInc(all.length? [{ id:'firms-agg', incident_name:'Satellite Heat Signatures', distance_miles:'~region', status:'active', acres: undefined, containment: 0, frp: all.reduce((s,h)=> s + (h.frp||0), 0).toFixed(1), confidence:'nominal', satellite:'FIRMS', created_date: new Date().toISOString() }] : []);
          } catch(e){ console.warn('FIRMS load failed', e); }

          // Derived fire weather & drought placeholders
          setFW({ source:'NWS derived', fire_danger_rating: (airQualityLike?.humidity!=null && airQualityLike?.wind_speed!=null && airQualityLike?.temperature!=null) ? ((airQualityLike.humidity<=20 && airQualityLike.wind_speed>=15)? 'Very High' : (airQualityLike.humidity<=30 && airQualityLike.wind_speed>=10) || airQualityLike.temperature>=90 ? 'High' : airQualityLike.humidity<=40 ? 'Moderate' : 'Low') : 'Low', burning_index: null, ten_hour_fuel_moisture:null, hundred_hour_fuel_moisture:null, kbdi:null, forecast_text:'Derived from NWS hourly near county centroids.', red_flag_warning:false });
          setDr(null);

          setLastUpdate(new Date());
        };

        useEffect(()=>{ load(); const t=setInterval(load, 15*60*1000); return ()=>clearInterval(t); },[]);
        const refresh = async()=>{ setIsRefreshing(true); await load(); setIsRefreshing(false); };
        return { lastUpdate, isRefreshing, refresh, airQuality: airQualityLike, incidents, stations, fireWeather, drought, alerts, hotspots };
      }

      /* ------------------ Feature Components ------------------ */
      function MetricsCard({ title, value, unit, status, description }){
        const statusColors = { good:'bg-green-500/20 text-green-400', moderate:'bg-yellow-500/20 text-yellow-400', warning:'bg-orange-500/20 text-orange-400', danger:'bg-red-500/20 text-red-400' };
        return (
          <Card className="relative overflow-hidden hover:border-orange-500/30 transition-all">
            <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-orange-500/10 to-transparent rounded-full blur-2xl" />
            <CardHeader className="pb-2">
              <div className="flex items-start justify-between">
                <div>
                  <CardTitle className="text-sm text-slate-400">{title}</CardTitle>
                  {description && <p className="text-xs text-slate-500 mt-1">{description}</p>}
                </div>
                <div className="p-2.5 rounded-xl bg-orange-500/10">üî•</div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="flex items-baseline gap-2">
                <span className="text-3xl font-bold text-white">{value ?? '‚Äî'}</span>
                {unit && <span className="text-lg text-slate-400">{unit}</span>}
              </div>
              {status && <div className="mt-3"><Badge className={cn('border-0 font-medium', statusColors[status])}>{status[0].toUpperCase()+status.slice(1)}</Badge></div>}
            </CardContent>
          </Card>
        );
      }

      function AirQualityCard({ data }){
        if(!data){
          return (<Card><CardHeader><CardTitle>Air Quality</CardTitle></CardHeader><CardContent><p className="text-slate-400">Loading air quality data‚Ä¶</p></CardContent></Card>);
        }
        const style = AQI_STYLES[data.category] || AQI_STYLES['Good'];
        return (
          <Card className={cn('border-2 hover:shadow-lg hover:shadow-orange-500/10', style.border)}>
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Air Quality Index</CardTitle>
                <Badge className={cn(style.bg, style.text, 'border-0 font-bold px-3 py-1')}>{data.category}</Badge>
              </div>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="text-center py-4">
                <div className="text-6xl font-bold text-white mb-2">{data.aqi}</div>
                <p className="text-slate-400 text-sm">Current AQI Level (derived)</p>
                <Progress value={(data.aqi/500)*100} className="mt-4" />
              </div>
              <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-700/50 text-sm">
                <div><div className="text-slate-400 text-xs">Wind Speed</div><p className="text-white font-semibold">{data.wind_speed ?? '‚Äî'} mph</p><p className="text-slate-500 text-xs">{data.wind_direction || '‚Äî'}</p></div>
                <div><div className="text-slate-400 text-xs">Humidity</div><p className="text-white font-semibold">{data.humidity ?? '‚Äî'}%</p></div>
                <div><div className="text-slate-400 text-xs">Temperature</div><p className="text-white font-semibold">{data.temperature ?? '‚Äî'}¬∞F</p></div>
                <div><div className="text-slate-400 text-xs">PM2.5</div><p className="text-white font-semibold">{data.pm25 ?? 0} Œºg/m¬≥</p></div>
              </div>
              <div className={cn('mt-4 p-3 rounded-lg border', style.bg, style.border)}>
                <p className="text-xs text-slate-300 font-medium">Fire Danger Level</p>
                <p className={cn('text-lg font-bold mt-1', style.text)}>{data.fire_danger_level}</p>
              </div>
            </CardContent>
          </Card>
        );
      }

      function ActiveAlerts({ incidents }){
        if(!incidents?.length){
          return (
            <Card>
              <CardHeader><CardTitle>Active Fire Incidents</CardTitle></CardHeader>
              <CardContent>
                <div className="text-center py-8">
                  <div className="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-3">‚úÖ</div>
                  <p className="text-green-400 font-semibold">All Clear</p>
                  <p className="text-slate-500 text-sm mt-1">No active fire incidents detected</p>
                </div>
              </CardContent>
            </Card>
          );
        }
        const statusColor = (s)=> s==='active'?'bg-red-500/20 text-red-400 border-red-500/30': s==='contained'?'bg-yellow-500/20 text-yellow-400 border-yellow-500/30': s==='controlled'?'bg-blue-500/20 text-blue-400 border-blue-500/30':'bg-slate-500/20 text-slate-400';
        const confColor = (c)=> c==='high'?'text-red-400': c==='nominal'?'text-yellow-400':'text-slate-400';
        return (
          <Card className="hover:border-orange-500/30 transition-all">
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Active Fire Incidents</CardTitle>
                <Badge className="bg-orange-500/20 text-orange-400 border-0 font-bold">{incidents.length}</Badge>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-3 max-h-96 overflow-auto pr-1">
                {incidents.map((x)=> (
                  <div key={x.id} className="p-4 rounded-lg bg-slate-900/50 border border-slate-700/50 hover:border-orange-500/30">
                    <div className="flex items-start justify-between mb-2">
                      <div>
                        <h4 className="font-semibold text-white">{x.incident_name}</h4>
                        <div className="mt-1 text-xs text-slate-400">üìç {x.distance_miles ?? '‚Äî'} miles away</div>
                      </div>
                      <Badge className={cn('border', statusColor(x.status||'active'))}>{x.status||'active'}</Badge>
                    </div>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div><p className="text-slate-500 text-xs">Acres Burned</p><p className="text-white font-semibold">{x.acres ?? 'N/A'}</p></div>
                      <div><p className="text-slate-500 text-xs">Containment</p><p className="text-white font-semibold">{x.containment ?? 0}%</p></div>
                      <div><p className="text-slate-500 text-xs">Fire Power</p><div className="flex items-center gap-1"><span className={cn(confColor(x.confidence||'nominal'))}>‚ñ≤</span><p className="text-white font-semibold">{x.frp ?? 0} MW</p></div></div>
                      <div><p className="text-slate-500 text-xs">Confidence</p><p className={cn('font-semibold', confColor(x.confidence||'nominal'))}>{x.confidence||'nominal'}</p></div>
                    </div>
                    <div className="mt-3 pt-3 border-t border-slate-700/50 text-xs text-slate-500">Source: {x.satellite||'FIRMS'} ‚Ä¢ {new Date(x.created_date||Date.now()).toLocaleString()}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        );
      }

      function TrendsChart(){
        const trendData = [
          { date:'Mon', aqi:45, fires:0, temp:72 },
          { date:'Tue', aqi:52, fires:1, temp:75 },
          { date:'Wed', aqi:48, fires:1, temp:78 },
          { date:'Thu', aqi:55, fires:2, temp:80 },
          { date:'Fri', aqi:68, fires:3, temp:82 },
          { date:'Sat', aqi:72, fires:2, temp:79 },
          { date:'Sun', aqi:58, fires:1, temp:76 },
        ];

        if (!hasRecharts) {
          const width = 900, height = 300, pad = 32;
          const xs = i => pad + (i*(width-2*pad))/(trendData.length-1);
          const aqiVals = trendData.map(d=>d.aqi);
          const minA = Math.min(...aqiVals, 0), maxA = Math.max(...aqiVals, 80);
          const yA = v => height-pad - ( (v-minA)/(maxA-minA||1) )*(height-2*pad);
          const areaPath = trendData.map((d,i)=>`${i?'L':'M'}${xs(i)},${yA(d.aqi)}`).join(' ')+` L${xs(trendData.length-1)},${height-pad} L${xs(0)},${height-pad} Z`;
          return (
            <Card>
              <CardHeader><CardTitle>7‚ÄëDay Trends (fallback)</CardTitle></CardHeader>
              <CardContent>
                <div className="text-xs text-slate-400 mb-2">Charts library blocked; showing lightweight SVG instead.</div>
                <div className="w-full overflow-x-auto">
                  <svg width={width} height={height} role="img" aria-label="AQI and fires over 7 days">
                    <rect x="0" y="0" width={width} height={height} fill="transparent" />
                    <path d={areaPath} fill="#f9731655" stroke="#f97316" strokeWidth="2" />
                    {trendData.map((d,i)=> (
                      <rect key={i} x={xs(i)-8} y={height-pad- d.fires*20} width="16" height={d.fires*20} fill="#ef4444" opacity="0.8" />
                    ))}
                    {trendData.map((d,i)=> (
                      <text key={'t'+i} x={xs(i)} y={height-6} fontSize="10" textAnchor="middle" fill="#94a3b8">{d.date}</text>
                    ))}
                  </svg>
                </div>
              </CardContent>
            </Card>
          );
        }

        return (
          <Card>
            <CardHeader><CardTitle>7‚ÄëDay Trends</CardTitle></CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={trendData}>
                  <defs>
                    <linearGradient id="colorAqi" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#f97316" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#f97316" stopOpacity={0} />
                    </linearGradient>
                    <linearGradient id="colorFires" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" opacity={0.3} />
                  <XAxis dataKey="date" stroke="#94a3b8" style={{ fontSize: '12px' }} />
                  <YAxis stroke="#94a3b8" style={{ fontSize: '12px' }} />
                  <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} />
                  <Legend wrapperStyle={{ color: '#94a3b8', fontSize: '12px' }} />
                  <Area type="monotone" dataKey="aqi" stroke="#f97316" fillOpacity={1} fill="url(#colorAqi)" name="Air Quality Index" />
                  <Area type="monotone" dataKey="fires" stroke="#ef4444" fillOpacity={1} fill="url(#colorFires)" name="Active Fires" />
                </AreaChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        );
      }

      function NWSAlertBanner({ alerts }){
        if(!alerts?.length){
          return (
            <div className="rounded-lg border-2 border-green-500/30 bg-green-500/10 p-4">
              <div className="flex items-center gap-3">
                <div className="text-green-400 text-xl">‚úÖ</div>
                <div>
                  <h3 className="text-green-400 font-bold">NWS Alert Status: All Clear</h3>
                  <p className="text-slate-300 text-sm mt-1">No active fire weather alerts for AKQ (Wakefield) counties</p>
                </div>
              </div>
            </div>
          );
        }
        return (
          <div className="space-y-4">
            {alerts.map((a)=>{
              const isRedFlag = a.alert_type?.toLowerCase().includes('red flag');
              const isFW = a.alert_type?.toLowerCase().includes('fire weather');
              const wrap = cn('rounded-lg border-2 p-4 backdrop-blur-sm', isRedFlag? 'bg-red-500/10 border-red-500/50 shadow-lg shadow-red-500/20' : isFW? 'bg-orange-500/10 border-orange-500/50' : 'bg-yellow-500/10 border-yellow-500/50');
              return (
                <div key={a.id} className={wrap}>
                  <div className="flex items-start gap-3">
                    <div className={cn('text-xl', isRedFlag? 'text-red-400':'text-orange-400')}>{isRedFlag?'‚ö†Ô∏è':'‚ÑπÔ∏è'}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h3 className={cn('font-bold text-lg', isRedFlag? 'text-red-400':'text-orange-400')}>üö® {a.alert_type}</h3>
                        <Badge className={cn(a.severity==='Extreme'?'bg-purple-500/20 text-purple-400': a.severity==='Severe'?'bg-red-500/20 text-red-400':'bg-orange-500/20 text-orange-400')}>{a.severity}</Badge>
                      </div>
                      <p className="text-slate-300 text-sm mb-3"><strong>{a.headline}</strong></p>
                      {a.description && <p className="text-slate-400 text-sm mb-3">{a.description}</p>}
                      {a.instruction && (
                        <div className="p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 mb-3">
                          <p className="text-xs text-slate-500 uppercase font-semibold mb-1">Instructions</p>
                          <p className="text-sm text-slate-300">{a.instruction}</p>
                        </div>
                      )}
                      {!!a.affected_zones?.length && (
                        <div className="flex gap-2 flex-wrap mb-2">
                          {a.affected_zones.map((z,i)=> <Badge key={i} className="border border-slate-600/50 text-xs bg-slate-800/50">{z}</Badge>)}
                        </div>
                      )}
                      <div className="flex gap-4 text-xs text-slate-500 mt-2">
                        {a.onset && <span>Starts: {new Date(a.onset).toLocaleString()}</span>}
                        {a.expires && <span>Expires: {new Date(a.expires).toLocaleString()}</span>}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      function FireWeatherPanel({ fireWeather, drought }){
        const danger = fireWeather?.fire_danger_rating || 'Low';
        return (
          <div className="space-y-6">
            <Card className={cn('border-2', fireWeather?.red_flag_warning? 'border-red-500/50 shadow-lg shadow-red-500/20' : 'border-slate-700/50')}>
              <CardHeader><CardTitle>Fire Weather Outlook</CardTitle></CardHeader>
              <CardContent className="space-y-4">
                {fireWeather?.red_flag_warning && (
                  <div className="p-4 bg-red-500/10 border-2 border-red-500/50 rounded-lg">
                    <div className="flex items-center gap-2 text-red-400 font-bold mb-2">‚ö†Ô∏è RED FLAG WARNING ACTIVE</div>
                    <p className="text-sm text-slate-300">Critical fire weather conditions exist. Avoid any outdoor burning.</p>
                  </div>
                )}
                <div className="text-center py-2">
                  <p className="text-slate-400 text-sm mb-2">Current Fire Danger</p>
                  <Badge className={cn('text-2xl font-bold px-6 py-2 border', DANGER_STYLES[danger])}>{danger}</Badge>
                </div>
                <div className="text-xs text-slate-500 pt-2 border-t border-slate-700/50">Data from WFAS & National Weather Service</div>
              </CardContent>
            </Card>
            {drought && (
              <Card>
                <CardHeader><CardTitle>Drought Status</CardTitle></CardHeader>
                <CardContent className="space-y-4">
                  <div className="text-center"><p className="text-slate-400 text-sm mb-2">Current Classification</p><Badge className="text-lg font-bold px-4 py-2 bg-amber-500/20 text-amber-400 border-amber-500/30">{drought.drought_level || 'Normal'}</Badge></div>
                  <div className="text-xs text-slate-500 pt-3 border-t border-slate-700/50">Data from US Drought Monitor</div>
                </CardContent>
              </Card>
            )}
          </div>
        );
      }

      function ThemeToggle(){
        const [theme, setTheme] = useState('dark');
        useEffect(()=>{ const saved = localStorage.getItem('theme') || 'dark'; setTheme(saved); document.documentElement.classList.toggle('dark', saved==='dark'); },[]);
        const toggle = () => { const next = theme==='dark'?'light':'dark'; setTheme(next); localStorage.setItem('theme', next); document.documentElement.classList.toggle('dark', next==='dark'); };
        return (
          <button title={`Switch to ${theme==='dark'?'light':'dark'} mode`} onClick={toggle} className="fixed top-4 right-4 z-50 bg-slate-800/95 border border-slate-700/50 hover:bg-slate-700 rounded-lg px-3 py-2">{theme==='dark'?'üåû':'üåô'}</button>
        );
      }

      function ExternalLinksBar(){
        const linkBtn = 'inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-700/60 bg-slate-800/60 hover:bg-slate-700/60 text-sm';
        return (
          <div className="flex flex-wrap gap-3">
            <a className={linkBtn} href="https://firms.modaps.eosdis.nasa.gov/active_fire/" target="_blank" rel="noopener noreferrer">üî• NASA FIRMS</a>
            <a className={linkBtn} href="https://www.weather.gov/akq/" target="_blank" rel="noopener noreferrer">üèõÔ∏è NWS Wakefield (AKQ)</a>
            <a className={linkBtn} href="https://www.windy.com/?temp,37.09,-77.68,8" target="_blank" rel="noopener noreferrer">üü¢ Windy</a>
          </div>
        );
      }

      function MapHotspots({ hotspots }){
        const mapRef = useRef(null);
        const mapObj = useRef(null);
        const markers = useRef(null);
        useEffect(()=>{
          if (!window.L) return; // Leaflet not loaded
          if (!mapObj.current && mapRef.current) {
            const center = [37.09, -77.68];
            mapObj.current = L.map(mapRef.current).setView(center, 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mapObj.current);
            markers.current = L.layerGroup().addTo(mapObj.current);
          }
          if (!mapObj.current || !markers.current) return;
          // Clear and redraw
          markers.current.clearLayers();
          const colorFor = (c)=> c==='high'? '#ef4444' : c==='nominal'? '#f59e0b' : '#94a3b8';
          hotspots.forEach(h=>{
            const marker = L.circleMarker([h.lat,h.lng], { radius: 5.5, color: colorFor(h.confidence), fillColor: colorFor(h.confidence), fillOpacity: 0.9, weight: 1});
            const popup = '<strong>'+ (h.satellite||'FIRMS') +'</strong><br/>'+
                          'Confidence: '+ (h.confidence||'-') + (h.frp? ('<br/>FRP: '+h.frp+' MW') : '') + (h.acq_date? ('<br/>' + h.acq_date + ' ' + (h.acq_time||'')) : '');
            marker.bindPopup(popup);
            marker.addTo(markers.current);
          });
          return ()=>{};
        }, [hotspots]);
        return (
          <Card className="overflow-hidden">
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Hotspots Map (Last 24h)</CardTitle>
                <span className="text-xs text-slate-400">NASA FIRMS / OSM</span>
              </div>
            </CardHeader>
            <CardContent>
              <div ref={mapRef} style={{height:'360px', width:'100%', borderRadius:'0.75rem'}} className="border border-slate-700/50" />
              <div className="flex items-center gap-3 mt-3 text-xs">
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-full" style={{background:'#ef4444'}}></span> High</span>
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-full" style={{background:'#f59e0b'}}></span> Nominal</span>
                <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-full" style={{background:'#94a3b8'}}></span> Low</span>
              </div>
              <div className="mt-3">
                <WindyEmbed />
              </div>
            </CardContent>
          </Card>
        );
      }

      function WindyEmbed(){
        const src = 'https://www.windy.com/?temp,37.09,-77.68,8';
        return (
          <div className="rounded-lg overflow-hidden border border-slate-700/50">
            <iframe title="Windy" src={src} style={{width:'100%', height:'300px', border:0}} loading="lazy" referrerPolicy="no-referrer" />
          </div>
        );
      }

      /* ------------------ App Shell ------------------ */
      function App(){
        const { lastUpdate, isRefreshing, refresh, airQuality, incidents, stations, fireWeather, drought, alerts, hotspots } = useLiveData();
        const minutesAgo = lastUpdate ? (Math.floor((Date.now()-lastUpdate.getTime())/60000)) : null;
        return (
          <div className="min-h-screen p-4 md:p-8">
            <ThemeToggle />
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                  <h1 className="text-3xl md:text-4xl font-bold text-white mb-2">Five Forks Fire Weather ‚Äî Live</h1>
                  <p className="text-slate-400">Live data from NWS & NASA FIRMS (plus Windy embed)</p>
                </div>
                <div className="flex items-center gap-3">
                  <div className="text-right">
                    <p className="text-xs text-slate-500">Last updated</p>
                    <p className="text-sm text-slate-300 font-medium">{minutesAgo===null ? '‚Äî' : minutesAgo===0 ? 'Just now' : minutesAgo===1 ? '1 min ago' : `${minutesAgo} min ago`}</p>
                  </div>
                  <Button onClick={refresh} disabled={isRefreshing}>{isRefreshing ? 'Refreshing‚Ä¶' : 'Refresh'}</Button>
                </div>
              </div>

              {/* Alerts */}
              <div className="mb-8"><NWSAlertBanner alerts={alerts} /></div>

              {/* Top metrics */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <MetricsCard
                title="Active Hotspots"
                value={( () => { const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' }); return (hotspots||[]).filter(h => h.acq_date === today).length; })()}
                status={ ( () => { const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' }); const n = (hotspots||[]).filter(h => h.acq_date === today).length; return n>20?'danger': n>10?'warning':'good'; })() }
                description="FIRMS (today) in ~2¬∞ bbox"
              />
                <MetricsCard title="Temperature" value={airQuality?.temperature ?? '‚Äî'} unit="¬∞F" status={(airQuality?.temperature>85)?'warning':'good'} description="NWS (avg across counties)" />
                <MetricsCard title="Wind Speed" value={airQuality?.wind_speed ?? '‚Äî'} unit="mph" status={(airQuality?.wind_speed>15)?'warning':'good'} description={airQuality?.wind_direction || '‚Äî'} />
                <MetricsCard title="Humidity" value={airQuality?.humidity ?? '‚Äî'} unit="%" status={(airQuality?.humidity<30)?'warning':'good'} description="NWS (avg)" />
              </div>

              {/* Main */}
              <div className="grid lg:grid-cols-3 gap-6 mb-8">
                <div className="lg:col-span-2 space-y-6">
                  <ActiveAlerts incidents={incidents} />
                  <MapHotspots hotspots={hotspots} />
                </div>
                <div className="space-y-6">
                  <ExternalLinksBar />
                  <AirQualityCard data={airQuality} />
                  <FireWeatherPanel fireWeather={fireWeather} drought={drought} />
                </div>
              </div>

              <TrendsChart />

              {/* Footer */}
              <div className="mt-8 p-6 bg-slate-800/30 backdrop-blur-sm rounded-xl border border-slate-700/50">
                <div className="grid md:grid-cols-3 gap-6 text-center">
                  <div><p className="text-slate-500 text-sm mb-1">Data Sources</p><p className="text-slate-300 font-semibold">NASA FIRMS, NWS, OSM</p></div>
                  <div><p className="text-slate-500 text-sm mb-1">Update Frequency</p><p className="text-slate-300 font-semibold">Every 15 minutes</p></div>
                  <div><p className="text-slate-500 text-sm mb-1">Region</p><p className="text-slate-300 font-semibold">~Five Forks, VA</p></div>
                </div>
                <div className="mt-4"><Diagnostics /></div>
              </div>
            </div>
          </div>
        );
      }

      /* ------------------ Mount ------------------ */
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    </script>
  </body>
</html>
