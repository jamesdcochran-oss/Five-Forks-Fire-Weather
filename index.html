<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fire Weather — Six Counties (VA)</title>

  <!-- Add Leaflet styles for the map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  
  <script>
    // Tailwind configuration and safelist for dynamically generated badge classes
    tailwind = { config: { safelist: [
      'bg-red-600/10','text-red-700','ring-1','ring-red-600/20',
      'bg-orange-500/10','text-orange-700','ring-orange-500/20',
      'bg-amber-400/10','text-amber-700','ring-amber-400/20',
      'bg-emerald-500/10','text-emerald-700','ring-emerald-500/20',
      'bg-slate-300','text-slate-700'
    ]}};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Custom styles for dashboard aesthetics */
    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .badge { display:inline-flex; align-items:center; padding:2px 8px; border-radius:9999px;
             font-size:0.75rem; font-weight:600; line-height:1rem; }
    /* Leaflet specific styles */
    #map { z-index: 1; }
    .leaflet-container { height: 100%; width: 100%; }
    .leaflet-popup-content-wrapper { border-radius: 0.5rem; }
  </style>
</head>
<body class="bg-gray-50 font-sans p-4 sm:p-6 lg:p-8">

  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-3xl font-extrabold text-gray-900">Fire Weather — Six Counties (VA)</h1>
      <p class="text-gray-500">Real-time data for temperature, humidity, and wind to assess fire risk.</p>
    </header>

    <!-- Alerts Panel -->
    <div id="alerts-panel" class="bg-white rounded-xl shadow-lg ring-1 ring-gray-100 p-6 mb-6">
      <div class="text-gray-500">Fetching alerts…</div>
    </div>

    <!-- Map & Selection Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Map Section -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-1 ring-gray-100 p-4">
        <h2 class="text-lg font-bold text-gray-800 mb-3">Area Map & County Selection</h2>
        <div id="map" class="h-[300px] w-full rounded-lg bg-slate-200"></div>
        <p id="map-message" class="text-sm text-gray-500 mt-2 text-center hidden">Click a marker to select a county.</p>
      </div>

      <!-- Detail Card (Selected County) -->
      <div class="bg-white rounded-xl shadow-lg ring-1 ring-gray-100 p-6 flex flex-col justify-between">
        <h2 id="county-title" class="text-xl font-bold text-gray-800 mb-4">Select a County on the Map</h2>
        <div id="county-data" class="space-y-4">
          <div class="flex items-center justify-between">
            <span class="text-gray-500">Temperature</span>
            <span id="detail-t" class="text-3xl font-extrabold text-gray-900 num">—</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-gray-500">Relative Humidity (RH)</span>
            <span id="detail-rh" class="text-3xl font-extrabold text-gray-900 num">—</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-gray-500">Wind Speed (W)</span>
            <span id="detail-w" class="text-3xl font-extrabold text-gray-900 num">—</span>
          </div>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-100 text-sm">
          <p class="text-gray-500">Fire Danger Assessment (Simplified):</p>
          <div id="detail-badge" class="mt-2 badge bg-slate-300 text-slate-700">
            Awaiting Data
          </div>
        </div>
      </div>
    </div>

    <!-- County List (Data Grid) -->
    <div class="bg-white rounded-xl shadow-lg ring-1 ring-gray-100 p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">All County Overview</h2>
      <div id="county-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        <!-- County cards will be rendered here -->
      </div>
    </div>
  </div>
  
  <!-- Leaflet script MUST be loaded before the application script that calls L.map -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20n6aW81p4k+FaKocW06YJcWJjJ48IjsyL4J0N8h96v4=" crossorigin=""></script>

  <script>
    /* -------------------------------------------------------------------------- */
    /* GEOJSON DATA (Coordinates for the six Virginia Counties) */
    /* -------------------------------------------------------------------------- */
    const geoJsonData = {
      "type": "FeatureCollection",
      "features": [
        // County markers (points)
        {"type":"Feature","id":"83f50eef-2235-44b1-9e6c-9c59491b4a24","properties":{"title":"Dinwiddie"},"geometry":{"type":"Point","coordinates":[-77.60261,37.02153]}},
        {"type":"Feature","id":"af1bedd5-4aa5-4c09-b204-51bd6117bd65","properties":{"title":"Amelia"},"geometry":{"type":"Point","coordinates":[-77.99537,37.32646]}},
        {"type":"Feature","id":"8d110fd1-adbb-488e-a337-3e62aa363344","properties":{"title":"Nottoway"},"geometry":{"type":"Point","coordinates":[-78.03382,37.14824]}},
        {"type":"Feature","id":"931bd399-bf37-4978-a93e-22fc0939fba7","properties":{"title":"Brunswick"},"geometry":{"type":"Point","coordinates":[-77.85049,36.78112]}},
        {"type":"Feature","id":"67df6d39-46fd-4ed0-9a24-02de31fca159","properties":{"title":"Greensville"},"geometry":{"type":"Point","coordinates":[-77.56347,36.6413]}},
        {"type":"Feature","id":"d2a525bc-fd93-4eb3-9fdc-6bcc486d7639","properties":{"title":"Prince George"},"geometry":{"type":"Point","coordinates":[-77.18101,37.1881]}},
        // Polygon boundary for visualization
        {"type":"Feature","id":"5785a3d9-f1e7-4903-be7d-0a2c6792938d","properties":{},"geometry":{"type":"Polygon","coordinates":[[[-78.2350117578125,37.363789898359414],[-78.23089188476563,37.29062448283949],[-78.240504921875,37.11755644626926],[-78.21578568359375,37.08250638697882],[-78.15948075195313,37.04634403220737],[-78.07845658203125,37.00797118486934],[-78.00567215859313,37.020830045694964],[-78.0482441796875,36.54218923323913],[-77.28744095703125,36.54217934004624],[-77.41927689453125,36.697591947028855],[-77.4549824609375,36.74712573578124],[-77.46322220703125,36.86427710321731],[-77.54012650390625,36.859882122283764],[-77.6087910546875,36.880756030323596],[-77.15423172851563,37.115021710981814],[-77.07320755859375,37.17741654078484],[-76.96471756835938,37.247412528316616],[-76.99218338867188,37.299453009740276],[-77.0210225,37.306007271306434],[-77.06908768554688,37.26776602706855],[-77.08282059570313,37.27541583062041],[-77.09106034179688,37.31365318781136],[-77.12813919921875,37.303822580920595],[-77.23662918945313,37.31692977113898],[-77.35473221679688,37.23606570446547],[-77.32726639648438,37.19231923958888],[-77.34374588867188,37.16824787325909],[-77.39181107421875,37.170436496249174],[-77.42339676757813,37.16277603847045],[-77.43163651367188,37.185755082241165],[-77.45635575195313,37.18794319808966],[-77.44536942382813,37.21638293433666],[-77.515407265625,37.21857016247888],[-77.5978047265625,37.25792942330379],[-77.64998978515625,37.26667313454041],[-77.66646927734375,37.29320183064708],[-77.71041458984375,37.303033825915705],[-77.7680928125,37.284461200413624],[-77.79830521484375,37.328154196565244],[-77.84774369140625,37.35435780585329],[-77.87520951171875,37.38709945830021],[-77.86422318359375,37.45318674511003],[-77.92876786132813,37.48261602071299],[-78.00155228515625,37.49787108359377],[-78.086696328125,37.45588769581372],[-78.13888138671875,37.46024816203661],[-78.18969315429688,37.446075717235935],[-78.22539872070313,37.40136041928257],[-78.23913163085938,37.382812099276194],[-78.2350117578125,37.362076193229214],[-78.2350117578125,37.363789898359414]]]}}
      ]
    };

    /* -------------------------------------------------------------------------- */
    /* UTILITY FUNCTIONS                                                          */
    /* -------------------------------------------------------------------------- */
    const $ = (id) => document.getElementById(id);
    const countySlug = (title) => title.toLowerCase().replace(/\s/g, '_');
    
    // Simple custom alert dialog replacement (as alert() is forbidden)
    function showMessage(title, message) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4';
        dialog.innerHTML = `
            <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">${title}</h3>
                <p class="text-sm text-gray-600 mb-6">${message}</p>
                <div class="flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }

    /* -------------------------------------------------------------------------- */
    /* FIRE DANGER LOGIC                                                          */
    /* -------------------------------------------------------------------------- */
    // This is a simplified assessment logic based on key weather parameters
    function getFireDanger(temp, rh, wind) {
      if (temp === '–' || rh === '–' || wind === '–') {
        return { label: 'Data Missing', classes: 'bg-slate-300 text-slate-700' };
      }

      const t = parseFloat(temp);
      const h = parseFloat(rh);
      // Extract the numeric part of the wind speed string (e.g., "5 mph" -> 5)
      const w = parseInt(wind.match(/\d+/)?.[0] || '0');

      if (h <= 20 && w >= 15) {
        return { label: 'EXTREME RISK', classes: 'bg-red-600/10 text-red-700 ring-1 ring-red-600/20' };
      } else if ((h <= 25 && w >= 10) || t >= 90) {
        return { label: 'HIGH RISK', classes: 'bg-orange-500/10 text-orange-700 ring-orange-500/20' };
      } else if (h <= 35) {
        return { label: 'MODERATE RISK', classes: 'bg-amber-400/10 text-amber-700 ring-amber-400/20' };
      } else {
        return { label: 'LOW RISK', classes: 'bg-emerald-500/10 text-emerald-700 ring-emerald-500/20' };
      }
    }

    /* -------------------------------------------------------------------------- */
    /* API CALLS & CACHING (NWS API)                                              */
    /* -------------------------------------------------------------------------- */

    // Weather Forecast Office (WFO) ID covering these Virginia counties
    const WFO_ID = 'LWX'; 

    async function getHourly(lat, lon, { force = false } = {}) {
      const cacheKey = `hourly:${lat},${lon}`;
      const cache = sessionStorage.getItem(cacheKey);

      if (!force && cache) {
        const cachedData = JSON.parse(cache);
        // Check if cached data is less than 1 hour old
        if (Date.now() - cachedData.timestamp < 3600000) { 
          return cachedData.periods;
        }
      }

      let gridUrl;
      try {
        // 1. Get the forecast grid point URL from NWS
        const response = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
        if (!response.ok) throw new Error(`Status ${response.status}`);
        const data = await response.json();
        gridUrl = data.properties.forecastHourly;
      } catch (error) {
        console.error("Error fetching grid point:", error);
        throw new Error("Could not determine forecast grid.");
      }

      try {
        // 2. Fetch the hourly forecast data
        const response = await fetch(gridUrl);
        if (!response.ok) throw new Error(`Status ${response.status}`);
        const data = await response.json();
        const periods = data.properties.periods;

        // Cache the new data
        sessionStorage.setItem(cacheKey, JSON.stringify({
          periods: periods,
          timestamp: Date.now()
        }));

        return periods;
      } catch (error) {
        console.error("Error fetching hourly forecast:", error);
        throw new Error("Could not retrieve hourly forecast.");
      }
    }

    async function fetchAlerts(){
      const alertsPanel = $('alerts-panel');
      alertsPanel.innerHTML = '<div class="text-gray-500">Fetching alerts…</div>'; 

      try{
        // Fetch active alerts for the WFO covering this area (LWX)
        const r=await fetch(`https://api.weather.gov/alerts/active?area=${WFO_ID}`,{headers:{Accept:'application/geo+json'}});
        const j=await r.json();
        const feats = j?.features||[];

        if(!feats.length){
          alertsPanel.innerHTML = `<h3 class="text-lg font-bold text-gray-800 mb-2">Active Alerts (0)</h3><div class="text-gray-500">No active alerts reported for this area.</div>`;
          return;
        }

        const alertItems = feats.map(f => {
          const event = f?.properties?.event || 'Weather Alert';
          const id = f?.id; 
          const publicUrl = `https://alerts.weather.gov/cap/${id}`; // Link to NWS details
          
          return `<a href="${publicUrl}" target="_blank" class="block text-sm font-medium text-blue-600 hover:text-blue-700 transition truncate">${event}</a>`;
        });

        alertsPanel.innerHTML = `
          <h3 class="text-lg font-bold text-gray-800 mb-2">Active Alerts (${feats.length})</h3>
          <div class="space-y-1">
            ${alertItems.slice(0, 5).join('')}
            ${feats.length > 5 ? `<p class="text-xs text-gray-500 mt-1">... and ${feats.length - 5} more alerts. Click an alert above to view official NWS details.</p>` : ''}
          </div>
        `;

      }catch(e){
        console.error("Alerts fetching error:", e);
        alertsPanel.innerHTML = `<h3 class="text-lg font-bold text-gray-800 mb-2">Active Alerts</h3><div class="text-red-700">Alerts unavailable due to an API error.</div>`;
      }
    }


    /* -------------------------------------------------------------------------- */
    /* MAP & STATE MANAGEMENT                                                     */
    /* -------------------------------------------------------------------------- */
    let map, markerGroup;
    const countyDataMap = new Map();
    let currentCounty = null;

    function initializeMap() {
      // Initialize map centered roughly on the six counties area (VA)
      map = L.map('map', {
        center: [37.1, -77.75], 
        zoom: 9,
        zoomControl: false // Disable default zoom control
      });

      // Add Tile Layer (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      markerGroup = L.layerGroup().addTo(map);
      
      processGeoJsonData();
    }

    function processGeoJsonData() {
      const pointFeatures = geoJsonData.features.filter(f => f.geometry.type === 'Point');
      const polygonFeature = geoJsonData.features.find(f => f.geometry.type === 'Polygon');
      
      // 1. Process Point Features (Counties) and create markers
      pointFeatures.forEach(feature => {
        const title = feature.properties.title;
        const [lon, lat] = feature.geometry.coordinates;
        
        const county = {
          id: countySlug(title),
          title: title,
          lat: lat.toFixed(5),
          lon: lon.toFixed(5),
          data: { t: '–', rh: '–', w: '–' } // Placeholder for weather data
        };
        countyDataMap.set(county.id, county);
        
        // Add Marker
        const marker = L.marker([lat, lon]).addTo(markerGroup);
        marker.bindPopup(`<b>${title} County</b><br>Click to view details`);
        marker.on('click', () => selectCounty(county.id));
      });

      // 2. Add Polygon Feature (Area Boundary)
      if (polygonFeature) {
        L.geoJSON(polygonFeature, {
          style: (feature) => ({
            color: '#3b82f6', // blue-500
            weight: 2,
            opacity: 0.5,
            fillOpacity: 0.1
          })
        }).addTo(map);
      }

      // 3. Initial Data Load
      loadAllCountyData(pointFeatures);
    }
    
    // Handles clicking a marker or a county card
    function selectCounty(countyId) {
        const county = countyDataMap.get(countyId);
        if (!county) return;

        currentCounty = county;
        
        // Update Detail Card
        $('county-title').textContent = county.title;
        updateDetailCard(county.data);

        // Open the corresponding marker's popup on the map
        markerGroup.eachLayer(layer => {
            if (layer.getLatLng().lat.toFixed(5) == county.lat && layer.getLatLng().lng.toFixed(5) == county.lon) {
                layer.openPopup();
            }
        });

        // Update Grid Card Style (to show selection)
        renderCountyGrid();
    }
    
    function updateDetailCard(data) {
        $('detail-t').textContent = data.t;
        $('detail-rh').textContent = data.rh;
        $('detail-w').textContent = data.w;
        
        const danger = getFireDanger(data.t, data.rh, data.w);
        const badge = $('detail-badge');
        badge.textContent = danger.label;
        // Dynamically update Tailwind classes based on danger level
        badge.className = `mt-2 badge ${danger.classes}`; 
    }

    async function loadCountyData(county, force = false) {
      try {
        const periods = await getHourly(county.lat, county.lon, { force });
        const now = periods[0] || {};
        
        county.data = {
          t: (now.temperature != null ? `${now.temperature}°${now.temperatureUnit}` : '–'),
          rh: (now.relativeHumidity?.value != null ? `${Math.round(now.relativeHumidity.value)}%` : '–'),
          w: (now.windSpeed || '–')
        };
      } catch (error) {
        console.error(`Error loading data for ${county.title}:`, error);
        // Fallback data structure on error
        county.data = { t: '–', rh: '–', w: '–' };
      }
      
      // If this county is currently selected, update the detail view
      if (currentCounty && currentCounty.id === county.id) {
          updateDetailCard(county.data);
      }
      
      // Update the county grid card
      renderCountyGrid();
    }
    
    function loadAllCountyData(features) {
        features.forEach(f => {
            const id = countySlug(f.properties.title);
            const county = countyDataMap.get(id);
            if (county) {
                // Kick off the data fetch for each county
                loadCountyData(county);
            }
        });
    }

    /* -------------------------------------------------------------------------- */
    /* GRID RENDERING                                                             */
    /* -------------------------------------------------------------------------- */
    function renderCountyGrid() {
      const gridContainer = $('county-grid');
      gridContainer.innerHTML = '';
      
      countyDataMap.forEach(county => {
        const danger = getFireDanger(county.data.t, county.data.rh, county.data.w);
        
        const isSelected = currentCounty && currentCounty.id === county.id;
        
        const card = document.createElement('div');
        card.className = `p-3 rounded-lg border-2 transition-all cursor-pointer ${
            isSelected ? 'border-blue-500 bg-blue-50/50 shadow-md' : 'border-gray-100 hover:border-blue-200'
        }`;
        card.onclick = () => selectCounty(county.id);

        card.innerHTML = `
          <div class="text-sm font-semibold text-gray-800 truncate mb-1">${county.title}</div>
          <div class="text-xs space-y-1">
            <div class="flex justify-between items-center">
                <span class="text-gray-500">T:</span>
                <span class="font-bold text-gray-900 num">${county.data.t}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-500">RH:</span>
                <span class="font-bold text-gray-900 num">${county.data.rh}</span>
            </div>
          </div>
          <div class="mt-2 badge ${danger.classes} text-center w-full justify-center">
            ${danger.label}
          </div>
        `;
        gridContainer.appendChild(card);
      });
    }


    /* -------------------------------------------------------------------------- */
    /* INITIAL SETUP RUN                                                          */
    /* -------------------------------------------------------------------------- */
    window.onload = function() {
        // Initializes the Leaflet map
        initializeMap(); 
        
        // Fetches and displays NWS alerts
        fetchAlerts();
        
        // Initial render of the grid (will populate as data arrives)
        renderCountyGrid();
    }
  </script>
</body>
</html>
