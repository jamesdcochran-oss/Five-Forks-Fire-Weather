<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Five Forks Fire Weather ‚Äî Demo</title>

    <!-- Tailwind (CDN) -->
    <script>
      window.tailwind = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React / ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel (so we can write JSX in-browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts UMD (optional; app gracefully falls back if blocked) -->
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.min.js"></script>

    <!-- Leaflet (for embedded map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      html, body, #root { height: 100%; }
      body { margin: 0; }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      /* ------------------ Optional Recharts ------------------ */
      function getRechartsLib(){
        // If present, use it. If blocked, return null and we render fallbacks.
        return window.Recharts ?? null;
      }
      const RechartsLib = getRechartsLib();
      const hasRecharts = !!RechartsLib;
      let AreaChart, Area, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend;
      if (hasRecharts) {
        ({ AreaChart, Area, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = RechartsLib);
      }

      /* ------------------ Tiny UI primitives ------------------ */
      const cn = (...a) => a.filter(Boolean).join(' ');
      const Card = ({ className, children }) => (
        <div className={cn('rounded-xl border bg-slate-800/50 border-slate-700/50 backdrop-blur-sm', className)}>{children}</div>
      );
      const CardHeader = ({ className, children }) => <div className={cn('px-4 pt-4 pb-2', className)}>{children}</div>;
      const CardTitle = ({ className, children }) => <h3 className={cn('text-white font-semibold text-base', className)}>{children}</h3>;
      const CardContent = ({ className, children }) => <div className={cn('px-4 pb-4', className)}>{children}</div>;
      const Badge = ({ className, children }) => (
        <span className={cn('inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-slate-700/40 text-slate-200', className)}>{children}</span>
      );
      const Button = ({ className, children, ...props }) => (
        <button {...props} className={cn('inline-flex items-center justify-center gap-2 rounded-lg px-3 py-2 bg-orange-500 text-white hover:bg-orange-600 disabled:opacity-60', className)}>{children}</button>
      );
      const Progress = ({ value, className }) => {
        const pct = Math.max(0, Math.min(100, value ?? 0));
        return (
          <div className={cn('w-full h-2 rounded bg-slate-700/50', className)}>
            <div className="h-2 rounded bg-orange-500" style={{ width: pct + '%' }} />
          </div>
        );
      };

      /* ------------------ Diagnostics ("tests") ------------------ */
      function Diagnostics(){
        const tests = [
          { name: 'React present', pass: !!window.React },
          { name: 'ReactDOM present', pass: !!window.ReactDOM && !!window.ReactDOM.createRoot },
          { name: 'Leaflet present', pass: !!window.L },
          { name: 'Recharts present (optional)', pass: !!window.Recharts },
        ];
        return (
          <div className="text-xs text-slate-400 flex flex-wrap gap-2">
            {tests.map((t, i)=> (
              <span key={i} className={cn('px-2 py-1 rounded border', t.pass?'border-green-500/40 bg-green-500/10 text-green-300':'border-slate-600/40 bg-slate-700/30 text-slate-300')}>
                {t.pass ? '‚úÖ' : '‚ö™'} {t.name}
              </span>
            ))}
          </div>
        );
      }

      /* ------------------ Helpers ------------------ */
      const AQI_STYLES = {
        'Good': { bg: 'bg-green-500/20', text: 'text-green-400', border: 'border-green-500/30' },
        'Moderate': { bg: 'bg-yellow-500/20', text: 'text-yellow-400', border: 'border-yellow-500/30' },
        'Unhealthy for Sensitive Groups': { bg: 'bg-orange-500/20', text: 'text-orange-400', border: 'border-orange-500/30' },
        'Unhealthy': { bg: 'bg-red-500/20', text: 'text-red-400', border: 'border-red-500/30' },
        'Very Unhealthy': { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/30' },
        'Hazardous': { bg: 'bg-red-900/30', text: 'text-red-300', border: 'border-red-800/50' },
      };
      const DANGER_STYLES = {
        'Low': 'bg-green-500/20 text-green-400 border-green-500/30',
        'Moderate': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
        'High': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
        'Very High': 'bg-red-500/20 text-red-400 border-red-500/30',
        'Extreme': 'bg-purple-500/20 text-purple-400 border-purple-500/30',
      };
      const timeSince = (d) => {
        const diff = Math.floor((Date.now() - d.getTime()) / 60000);
        if (diff <= 0) return 'Just now';
        if (diff === 1) return '1 min ago';
        return diff + ' min ago';
      };
      const calcDanger = (h, wind, t, kbdi) => {
        let s = 0; if (h < 30) s += 2; if (wind > 15) s += 2; if (t > 85) s += 1; if (kbdi > 400) s += 2; if (kbdi > 600) s += 1; if (h < 20) s += 1;
        if (s >= 6) return { cls: '5', lvl: 'Extreme', css: DANGER_STYLES['Extreme'], icon: 'üî•' };
        if (s >= 5) return { cls: '4', lvl: 'Very High', css: DANGER_STYLES['Very High'], icon: 'üî•' };
        if (s >= 3) return { cls: '3', lvl: 'High', css: DANGER_STYLES['High'], icon: '‚ö†Ô∏è' };
        if (s >= 2) return { cls: '2', lvl: 'Moderate', css: DANGER_STYLES['Moderate'], icon: '„Ä∞Ô∏è' };
        return { cls: '1', lvl: 'Low', css: DANGER_STYLES['Low'], icon: '‚úÖ' };
      };

      /* ------------------ Mock Data Loader ------------------ */
      function useMockData(){
        const [lastUpdate, setLastUpdate] = useState(new Date());
        const [isRefreshing, setIsRefreshing] = useState(false);
        const [airQuality, setAir] = useState(null);
        const [incidents, setInc] = useState([]);
        const [stations, setSta] = useState([]);
        const [fireWeather, setFW] = useState(null);
        const [drought, setDr] = useState(null);
        const [alerts, setAl] = useState([]);
        const [hotspots, setHotspots] = useState([]);

        // --- helpers ---
        const center = { lat: 37.09, lng: -77.68 }; // Five Forks approx
        const inBBox = (lat, lon, pad=2.0) => (
          lat > center.lat - pad && lat < center.lat + pad &&
          lon > center.lng - pad && lon < center.lng + pad
        );
        const parseCSV = (text) => {
          // very small CSV parser for FIRMS
          const [headerLine, ...lines] = text.trim().split(/
?
/);
          const headers = headerLine.split(',');
          return lines.map(l=>{
            const cells = l.split(',');
            const row = {}; headers.forEach((h,i)=> row[h] = cells[i]);
            return row;
          });
        };

        const load = async () => {
          // Keep existing mocked widgets for now
          setAir({ aqi: 58, category: 'Moderate', primary_pollutant: 'PM2.5', pm25: 14, temperature: 78, humidity: 42, wind_speed: 9, wind_direction: 'NW', fire_danger_level: 'High' });
          setInc([{ id: 'a1', incident_name: 'Piney Ridge', distance_miles: 34, acres: 125, containment: 45, frp: 30, confidence: 'high', status: 'active', satellite: 'VIIRS', created_date: new Date().toISOString() }]);
          const names = ['Jetersville','Amelia Court House','Burkeville','Blackstone','Ebony','Brodnax','Emporia','Dinwiddie','Carson','Sutherland','Prince George'];
          setSta(names.map((n,i)=>({ id:'st-'+i, name:n, location:'VA', temperature:70+((i*3)%12), humidity:35+((i*7)%40), wind_speed:5+((i*2)%12), wind_gust:8+((i*3)%18), dew_point:55+(i%6), kbdi:350+((i*30)%300), aqi:40+((i*10)%70), last_updated:new Date().toISOString() })));
          setFW({ source:'WFAS/NWS', fire_danger_rating:'High', burning_index:63, spread_component:51, energy_release:42, ignition_component:18, ten_hour_fuel_moisture:6, hundred_hour_fuel_moisture:7, kbdi:447, forecast_text:'Warm, dry, and breezy this afternoon. RH 28‚Äì35%. 20-ft winds WNW 12‚Äì18 mph with gusts 22‚Äì28 mph.', red_flag_warning:false });
          setDr({ drought_level: 'D1 ‚Äì Moderate', percent_area_affected: 24, conditions_summary: 'Dry topsoil, stressed vegetation in sandy soils.', impacts: 'Voluntary water conservation recommended.'});

          // --- Live: NWS Wakefield alerts (area VA/NC/MD) ---
          try {
            const res = await fetch('https://api.weather.gov/alerts/active?area=VA,NC,MD');
            if (res.ok) {
              const json = await res.json();
              const feats = json.features || [];
              const mapped = feats.map(f=> ({
                id: f.id,
                alert_type: f.properties.event,
                severity: f.properties.severity,
                headline: f.properties.headline,
                description: f.properties.description,
                instruction: f.properties.instruction,
                affected_zones: f.properties.geocode?.UGC || [],
                onset: f.properties.onset,
                expires: f.properties.expires,
                is_active: true,
              }));
              // Prioritize Fire Weather alerts for AKQ region
              const prioritized = mapped.filter(a => /red flag|fire weather/i.test(a.alert_type||'') || /AKQ|Wakefield/i.test(a.headline||''));
              setAl(prioritized.length ? prioritized : mapped.slice(0,5));
            }
          } catch (e) {
            // keep previous
          }

          // --- Live: NASA FIRMS 24h (USA contiguous/Hawaii) VIIRS+MODIS via CSV ---
          // These CSV endpoints are public; we filter to our bbox and map confidence.
          const sources = [
            { url: 'https://firms.modaps.eosdis.nasa.gov/active_fire/c2/csv/VIIRS_C2_USA_contiguous_and_Hawaii_24h.csv', sat: 'VIIRS' },
            { url: 'https://firms.modaps.eosdis.nasa.gov/active_fire/c6.1/csv/MODIS_C6_1_USA_contiguous_and_Hawaii_24h.csv', sat: 'MODIS' },
          ];
          try {
            const allRows = [];
            for (const s of sources) {
              try {
                const r = await fetch(s.url, { cache: 'no-store' });
                if (r.ok) {
                  const txt = await r.text();
                  const rows = parseCSV(txt);
                  rows.forEach(row => {
                    const lat = parseFloat(row.latitude);
                    const lon = parseFloat(row.longitude);
                    if (!isFinite(lat) || !isFinite(lon)) return;
                    if (!inBBox(lat, lon, 2.0)) return; // ~2¬∞ bbox around Five Forks
                    const conf = (row.confidence_text || row.confidence || '').toString().toLowerCase();
                    const normConf = /high/.test(conf) ? 'high' : /nominal|medium|med/.test(conf) ? 'nominal' : 'low';
                    allRows.push({
                      lat, lng: lon,
                      confidence: normConf,
                      satellite: s.sat,
                      acq_date: row.acq_date,
                      acq_time: row.acq_time,
                      frp: parseFloat(row.frp)||undefined,
                    });
                  });
                }
              } catch(_){}
            }
            if (allRows.length) setHotspots(allRows);
          } catch (_) {}

          setLastUpdate(new Date());
        };

        useEffect(()=>{ load(); const t=setInterval(load, 15*60*1000); return ()=>clearInterval(t); },[]);
        const refresh = async()=>{ setIsRefreshing(true); await load(); setIsRefreshing(false); };
        return { lastUpdate, isRefreshing, refresh, airQuality, incidents, stations, fireWeather, drought, alerts, hotspots };
      }

      /* ------------------ Feature Components ------------------ */
      function MetricsCard({ title, value, unit, status, description }){
        const statusColors = { good:'bg-green-500/20 text-green-400', moderate:'bg-yellow-500/20 text-yellow-400', warning:'bg-orange-500/20 text-orange-400', danger:'bg-red-500/20 text-red-400' };
        return (
          <Card className="relative overflow-hidden hover:border-orange-500/30 transition-all">
            <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-orange-500/10 to-transparent rounded-full blur-2xl" />
            <CardHeader className="pb-2">
              <div className="flex items-start justify-between">
                <div>
                  <CardTitle className="text-sm text-slate-400">{title}</CardTitle>
                  {description && <p className="text-xs text-slate-500 mt-1">{description}</p>}
                </div>
                <div className="p-2.5 rounded-xl bg-orange-500/10">üî•</div>
              </div>
            </CardHeader>
            <CardContent>
              <div className="flex items-baseline gap-2">
                <span className="text-3xl font-bold text-white">{value}</span>
                {unit && <span className="text-lg text-slate-400">{unit}</span>}
              </div>
              {status && <div className="mt-3"><Badge className={cn('border-0 font-medium', statusColors[status])}>{status[0].toUpperCase()+status.slice(1)}</Badge></div>}
            </CardContent>
          </Card>
        );
      }

      function AirQualityCard({ data }){
        if(!data){
          return (<Card><CardHeader><CardTitle>Air Quality</CardTitle></CardHeader><CardContent><p className="text-slate-400">Loading air quality data‚Ä¶</p></CardContent></Card>);
        }
        const style = AQI_STYLES[data.category] || AQI_STYLES['Good'];
        return (
          <Card className={cn('border-2 hover:shadow-lg hover:shadow-orange-500/10', style.border)}>
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Air Quality Index</CardTitle>
                <Badge className={cn(style.bg, style.text, 'border-0 font-bold px-3 py-1')}>{data.category}</Badge>
              </div>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="text-center py-4">
                <div className="text-6xl font-bold text-white mb-2">{data.aqi}</div>
                <p className="text-slate-400 text-sm">Current AQI Level</p>
                <Progress value={(data.aqi/500)*100} className="mt-4" />
              </div>
              <div className="grid grid-cols-2 gap-4 pt-4 border-t border-slate-700/50 text-sm">
                <div><div className="text-slate-400 text-xs">Wind Speed</div><p className="text-white font-semibold">{data.wind_speed} mph</p><p className="text-slate-500 text-xs">{data.wind_direction}</p></div>
                <div><div className="text-slate-400 text-xs">Humidity</div><p className="text-white font-semibold">{data.humidity}%</p></div>
                <div><div className="text-slate-400 text-xs">Temperature</div><p className="text-white font-semibold">{data.temperature}¬∞F</p></div>
                <div><div className="text-slate-400 text-xs">PM2.5</div><p className="text-white font-semibold">{data.pm25} Œºg/m¬≥</p></div>
              </div>
              <div className={cn('mt-4 p-3 rounded-lg border', style.bg, style.border)}>
                <p className="text-xs text-slate-300 font-medium">Fire Danger Level</p>
                <p className={cn('text-lg font-bold mt-1', style.text)}>{data.fire_danger_level}</p>
              </div>
            </CardContent>
          </Card>
        );
      }

      function ActiveAlerts({ incidents }){
        if(!incidents?.length){
          return (
            <Card>
              <CardHeader><CardTitle>Active Fire Incidents</CardTitle></CardHeader>
              <CardContent>
                <div className="text-center py-8">
                  <div className="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-3">‚úÖ</div>
                  <p className="text-green-400 font-semibold">All Clear</p>
                  <p className="text-slate-500 text-sm mt-1">No active fire incidents detected</p>
                </div>
              </CardContent>
            </Card>
          );
        }
        const statusColor = (s)=> s==='active'?'bg-red-500/20 text-red-400 border-red-500/30': s==='contained'?'bg-yellow-500/20 text-yellow-400 border-yellow-500/30': s==='controlled'?'bg-blue-500/20 text-blue-400 border-blue-500/30':'bg-slate-500/20 text-slate-400';
        const confColor = (c)=> c==='high'?'text-red-400': c==='nominal'?'text-yellow-400':'text-slate-400';
        return (
          <Card className="hover:border-orange-500/30 transition-all">
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Active Fire Incidents</CardTitle>
                <Badge className="bg-orange-500/20 text-orange-400 border-0 font-bold">{incidents.length}</Badge>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-3 max-h-96 overflow-auto pr-1">
                {incidents.map((x)=> (
                  <div key={x.id} className="p-4 rounded-lg bg-slate-900/50 border border-slate-700/50 hover:border-orange-500/30">
                    <div className="flex items-start justify-between mb-2">
                      <div>
                        <h4 className="font-semibold text-white">{x.incident_name}</h4>
                        <div className="mt-1 text-xs text-slate-400">üìç {x.distance_miles} miles away</div>
                      </div>
                      <Badge className={cn('border', statusColor(x.status))}>{x.status}</Badge>
                    </div>
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div><p className="text-slate-500 text-xs">Acres Burned</p><p className="text-white font-semibold">{x.acres ?? 'N/A'}</p></div>
                      <div><p className="text-slate-500 text-xs">Containment</p><p className="text-white font-semibold">{x.containment ?? 0}%</p></div>
                      <div><p className="text-slate-500 text-xs">Fire Power</p><div className="flex items-center gap-1"><span className={cn(confColor(x.confidence))}>‚ñ≤</span><p className="text-white font-semibold">{x.frp} MW</p></div></div>
                      <div><p className="text-slate-500 text-xs">Confidence</p><p className={cn('font-semibold', confColor(x.confidence))}>{x.confidence}</p></div>
                    </div>
                    <div className="mt-3 pt-3 border-t border-slate-700/50 text-xs text-slate-500">Source: {x.satellite} ‚Ä¢ {new Date(x.created_date).toLocaleString()}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        );
      }

      function WeatherStationsList({ stations }){
        if(!stations?.length){
          return (<Card><CardHeader><CardTitle>Regional Weather Stations</CardTitle></CardHeader><CardContent><p className="text-slate-400">Fetching weather data‚Ä¶</p></CardContent></Card>);
        }
        return (
          <Card>
            <CardHeader><CardTitle>Regional Weather Stations</CardTitle></CardHeader>
            <CardContent>
              <div className="space-y-3 max-h-96 overflow-auto pr-1">
                {stations.map((s)=>{
                  const danger = calcDanger(s.humidity, s.wind_speed, s.temperature, s.kbdi);
                  return (
                    <div key={s.id} className="p-4 rounded-lg bg-slate-900/50 border border-slate-700/50 hover:border-orange-500/30">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h4 className="font-semibold text-white flex items-center gap-2">{s.name} <span className="text-lg">{danger.icon}</span></h4>
                          <p className="text-xs text-slate-400">{s.location}</p>
                        </div>
                        {typeof s.temperature==='number' && (
                          <div className="text-right">
                            <p className="text-2xl font-bold text-white">{Math.round(s.temperature)}¬∞F</p>
                            {s.dew_point!=null && <p className="text-xs text-slate-500">Dew {Math.round(s.dew_point)}¬∞</p>}
                          </div>
                        )}
                      </div>

                      <div className="mb-3"><Badge className={cn('border font-bold', danger.css)}>{danger.cls} - {danger.lvl}</Badge></div>

                      <div className="grid grid-cols-4 gap-3 text-sm">
                        <div><div className="text-slate-500 text-xs mb-1">RH</div><p className="text-white font-semibold">{Math.round(s.humidity)}%</p></div>
                        <div><div className="text-slate-500 text-xs mb-1">Wind</div><p className="text-white font-semibold">{Math.round(s.wind_speed)} mph</p>{s.wind_gust && (<p className="text-xs text-slate-400">G{s.wind_gust}</p>)}</div>
                        <div><div className="text-slate-500 text-xs mb-1">KBDI</div><p className="text-white font-semibold">{s.kbdi}</p></div>
                        <div><div className="text-slate-500 text-xs mb-1">AQI</div><p className="text-white font-semibold">{s.aqi}</p></div>
                      </div>

                      <div className="p-2 bg-slate-900/70 rounded border border-slate-700/30 font-mono text-xs mt-3">
                        <p className="text-slate-300">Temp {Math.round(s.temperature)}¬∞F | RH {Math.round(s.humidity)}% | Dew {Math.round(s.dew_point)}¬∞ | Wind {Math.round(s.wind_speed)} mph{s.wind_gust?` | Gust ${Math.round(s.wind_gust)}`:''} | KBDI {s.kbdi} | AQI {s.aqi}</p>
                      </div>

                      <div className="mt-3 pt-3 border-t border-slate-700/50"><p className="text-xs text-slate-500">Updated: {new Date(s.last_updated).toLocaleTimeString()}</p></div>
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        );
      }

      function TrendsChart(){
        const trendData = [
          { date:'Mon', aqi:45, fires:0, temp:72 },
          { date:'Tue', aqi:52, fires:1, temp:75 },
          { date:'Wed', aqi:48, fires:1, temp:78 },
          { date:'Thu', aqi:55, fires:2, temp:80 },
          { date:'Fri', aqi:68, fires:3, temp:82 },
          { date:'Sat', aqi:72, fires:2, temp:79 },
          { date:'Sun', aqi:58, fires:1, temp:76 },
        ];

        if (!hasRecharts) {
          // Fallback: simple inline SVG area for AQI + bars for fires
          const width = 900, height = 300, pad = 32;
          const xs = i => pad + (i*(width-2*pad))/(trendData.length-1);
          const aqiVals = trendData.map(d=>d.aqi);
          const minA = Math.min(...aqiVals, 0), maxA = Math.max(...aqiVals, 80);
          const yA = v => height-pad - ( (v-minA)/(maxA-minA||1) )*(height-2*pad);
          const areaPath = trendData.map((d,i)=>`${i?'L':'M'}${xs(i)},${yA(d.aqi)}`).join(' ')+` L${xs(trendData.length-1)},${height-pad} L${xs(0)},${height-pad} Z`;
          return (
            <Card>
              <CardHeader><CardTitle>7‚ÄëDay Trends (fallback)</CardTitle></CardHeader>
              <CardContent>
                <div className="text-xs text-slate-400 mb-2">Charts library blocked by network; rendering lightweight SVG instead.</div>
                <div className="w-full overflow-x-auto">
                  <svg width={width} height={height} role="img" aria-label="AQI and fires over 7 days">
                    <rect x="0" y="0" width={width} height={height} fill="transparent" />
                    <path d={areaPath} fill="#f9731655" stroke="#f97316" strokeWidth="2" />
                    {trendData.map((d,i)=> (
                      <rect key={i} x={xs(i)-8} y={height-pad- d.fires*20} width="16" height={d.fires*20} fill="#ef4444" opacity="0.8" />
                    ))}
                    {trendData.map((d,i)=> (
                      <text key={'t'+i} x={xs(i)} y={height-6} fontSize="10" textAnchor="middle" fill="#94a3b8">{d.date}</text>
                    ))}
                  </svg>
                </div>
                <div className="mt-2 text-xs text-slate-500">Legend: orange area = AQI, red bars = fires</div>
              </CardContent>
            </Card>
          );
        }

        return (
          <Card>
            <CardHeader><CardTitle>7‚ÄëDay Trends</CardTitle></CardHeader>
            <CardContent>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={trendData}>
                  <defs>
                    <linearGradient id="colorAqi" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#f97316" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#f97316" stopOpacity={0} />
                    </linearGradient>
                    <linearGradient id="colorFires" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3} />
                      <stop offset="95%" stopColor="#ef4444" stopOpacity={0} />
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" opacity={0.3} />
                  <XAxis dataKey="date" stroke="#94a3b8" style={{ fontSize: '12px' }} />
                  <YAxis stroke="#94a3b8" style={{ fontSize: '12px' }} />
                  <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px', color: '#fff' }} />
                  <Legend wrapperStyle={{ color: '#94a3b8', fontSize: '12px' }} />
                  <Area type="monotone" dataKey="aqi" stroke="#f97316" fillOpacity={1} fill="url(#colorAqi)" name="Air Quality Index" />
                  <Area type="monotone" dataKey="fires" stroke="#ef4444" fillOpacity={1} fill="url(#colorFires)" name="Active Fires" />
                </AreaChart>
              </ResponsiveContainer>
            </CardContent>
          </Card>
        );
      }

      function NWSAlertBanner({ alerts }){
        if(!alerts?.length){
          return (
            <div className="rounded-lg border-2 border-green-500/30 bg-green-500/10 p-4">
              <div className="flex items-center gap-3">
                <div className="text-green-400 text-xl">‚úÖ</div>
                <div>
                  <h3 className="text-green-400 font-bold">NWS Alert Status: All Clear</h3>
                  <p className="text-slate-300 text-sm mt-1">No active fire weather alerts for AKQ (Wakefield) counties</p>
                </div>
              </div>
            </div>
          );
        }
        return (
          <div className="space-y-4">
            {alerts.map((a)=>{
              const isRedFlag = a.alert_type?.toLowerCase().includes('red flag');
              const isFW = a.alert_type?.toLowerCase().includes('fire weather');
              const wrap = cn('rounded-lg border-2 p-4 backdrop-blur-sm', isRedFlag? 'bg-red-500/10 border-red-500/50 shadow-lg shadow-red-500/20' : isFW? 'bg-orange-500/10 border-orange-500/50' : 'bg-yellow-500/10 border-yellow-500/50');
              return (
                <div key={a.id} className={wrap}>
                  <div className="flex items-start gap-3">
                    <div className={cn('text-xl', isRedFlag? 'text-red-400':'text-orange-400')}>{isRedFlag?'‚ö†Ô∏è':'‚ÑπÔ∏è'}</div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h3 className={cn('font-bold text-lg', isRedFlag? 'text-red-400':'text-orange-400')}>üö® {a.alert_type}</h3>
                        <Badge className={cn(a.severity==='Extreme'?'bg-purple-500/20 text-purple-400': a.severity==='Severe'?'bg-red-500/20 text-red-400':'bg-orange-500/20 text-orange-400')}>{a.severity}</Badge>
                      </div>
                      <p className="text-slate-300 text-sm mb-3"><strong>{a.headline}</strong></p>
                      {a.description && <p className="text-slate-400 text-sm mb-3">{a.description}</p>}
                      {a.instruction && (
                        <div className="p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 mb-3">
                          <p className="text-xs text-slate-500 uppercase font-semibold mb-1">Instructions</p>
                          <p className="text-sm text-slate-300">{a.instruction}</p>
                        </div>
                      )}
                      {!!a.affected_zones?.length && (
                        <div className="flex gap-2 flex-wrap mb-2">
                          {a.affected_zones.map((z,i)=> <Badge key={i} className="border border-slate-600/50 text-xs bg-slate-800/50">{z}</Badge>)}
                        </div>
                      )}
                      <div className="flex gap-4 text-xs text-slate-500 mt-2">
                        {a.onset && <span>Starts: {new Date(a.onset).toLocaleString()}</span>}
                        {a.expires && <span>Expires: {new Date(a.expires).toLocaleString()}</span>}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      function FireWeatherPanel({ fireWeather, drought }){
        const danger = fireWeather?.fire_danger_rating || 'Low';
        return (
          <div className="space-y-6">
            <Card className={cn('border-2', fireWeather?.red_flag_warning? 'border-red-500/50 shadow-lg shadow-red-500/20' : 'border-slate-700/50')}>
              <CardHeader><CardTitle>Fire Weather Outlook</CardTitle></CardHeader>
              <CardContent className="space-y-4">
                {fireWeather?.red_flag_warning && (
                  <div className="p-4 bg-red-500/10 border-2 border-red-500/50 rounded-lg">
                    <div className="flex items-center gap-2 text-red-400 font-bold mb-2">‚ö†Ô∏è RED FLAG WARNING ACTIVE</div>
                    <p className="text-sm text-slate-300">Critical fire weather conditions exist. Avoid any outdoor burning.</p>
                  </div>
                )}
                <div className="text-center py-2">
                  <p className="text-slate-400 text-sm mb-2">Current Fire Danger</p>
                  <Badge className={cn('text-2xl font-bold px-6 py-2 border', DANGER_STYLES[danger])}>{danger}</Badge>
                </div>
                {typeof fireWeather?.burning_index==='number' && (
                  <div>
                    <div className="flex justify-between text-sm mb-2"><span className="text-slate-400">Burning Index</span><span className="text-white font-semibold">{fireWeather.burning_index}</span></div>
                    <Progress value={Math.min(fireWeather.burning_index, 100)} />
                  </div>
                )}
                <div className="grid grid-cols-3 gap-3 text-sm">
                  {typeof fireWeather?.ten_hour_fuel_moisture==='number' && (<div><p className="text-slate-500 text-xs">10‚Äëhr Fuel</p><p className="text-white font-semibold">{fireWeather.ten_hour_fuel_moisture}%</p></div>)}
                  {typeof fireWeather?.hundred_hour_fuel_moisture==='number' && (<div><p className="text-slate-500 text-xs">100‚Äëhr Fuel</p><p className="text-white font-semibold">{fireWeather.hundred_hour_fuel_moisture}%</p></div>)}
                  {typeof fireWeather?.kbdi==='number' && (<div><p className="text-slate-500 text-xs">KBDI</p><p className="text-white font-semibold">{fireWeather.kbdi}</p></div>)}
                </div>
                {fireWeather?.forecast_text && (<div className="mt-2 p-3 bg-slate-900/50 rounded-lg border border-slate-700/50"><p className="text-xs text-slate-400 mb-1">Forecast</p><p className="text-sm text-slate-300">{fireWeather.forecast_text}</p></div>)}
                <div className="text-xs text-slate-500 pt-2 border-t border-slate-700/50">Data from WFAS & National Weather Service</div>
              </CardContent>
            </Card>
            {drought && (
              <Card>
                <CardHeader><CardTitle>Drought Status</CardTitle></CardHeader>
                <CardContent className="space-y-4">
                  <div className="text-center"><p className="text-slate-400 text-sm mb-2">Current Classification</p><Badge className="text-lg font-bold px-4 py-2 bg-amber-500/20 text-amber-400 border-amber-500/30">{drought.drought_level || 'Normal'}</Badge></div>
                  {typeof drought.percent_area_affected==='number' && (
                    <div>
                      <div className="flex justify-between text-sm mb-2"><span className="text-slate-400">Area Affected</span><span className="text-white font-semibold">{drought.percent_area_affected}%</span></div>
                      <Progress value={drought.percent_area_affected} />
                    </div>
                  )}
                  {drought.conditions_summary && (<div className="p-3 bg-slate-900/50 rounded-lg border border-slate-700/50"><p className="text-sm text-slate-300">{drought.conditions_summary}</p></div>)}
                  {drought.impacts && (<div className="p-3 bg-amber-500/5 rounded-lg border border-amber-500/20"><p className="text-xs text-slate-400 mb-1">Impacts</p><p className="text-sm text-slate-300">{drought.impacts}</p></div>)}
                  <div className="text-xs text-slate-500 pt-3 border-t border-slate-700/50">Data from US Drought Monitor</div>
                </CardContent>
              </Card>
            )}
          </div>
        );
      }

      function ThemeToggle(){
        const [theme, setTheme] = useState('dark');
        useEffect(()=>{ const saved = localStorage.getItem('theme') || 'dark'; setTheme(saved); document.documentElement.classList.toggle('dark', saved==='dark'); },[]);
        const toggle = () => { const next = theme==='dark'?'light':'dark'; setTheme(next); localStorage.setItem('theme', next); document.documentElement.classList.toggle('dark', next==='dark'); };
        return (
          <button title={`Switch to ${theme==='dark'?'light':'dark'} mode`} onClick={toggle} className="fixed top-4 right-4 z-50 bg-slate-800/95 border border-slate-700/50 hover:bg-slate-700 rounded-lg px-3 py-2">{theme==='dark'?'üåû':'üåô'}</button>
        );
      }

      function ExternalLinksBar(){
        const linkBtn = 'inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-700/60 bg-slate-800/60 hover:bg-slate-700/60 text-sm';
        return (
          <div className="flex flex-wrap gap-3">
            <a className={linkBtn} href="https://firms.modaps.eosdis.nasa.gov/active_fire/" target="_blank" rel="noopener noreferrer">üî• NASA FIRMS</a>
            <a className={linkBtn} href="https://www.weather.gov/akq/" target="_blank" rel="noopener noreferrer">üèõÔ∏è NWS Wakefield (AKQ)</a>
            <a className={linkBtn} href="https://www.windy.com/?37.09,-77.68,8" target="_blank" rel="noopener noreferrer">üü¢ Windy</a>
          </div>
        );
      }

      function MapHotspots({ hotspots }){
        const mapRef = useRef(null);
        const mapObj = useRef(null);
        useEffect(()=>{
          if (!window.L) return; // Leaflet not loaded
          if (!mapObj.current && mapRef.current) {
            const center = [37.09, -77.68];
            mapObj.current = L.map(mapRef.current).setView(center, 9);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mapObj.current);
          }
          if (!mapObj.current) return;
          // Clear prior hotspot markers
          const toRemove = [];
          mapObj.current.eachLayer((layer)=>{
            if (layer instanceof L.CircleMarker) toRemove.push(layer);
          });
          toRemove.forEach(l => mapObj.current.removeLayer(l));
      function WindyEmbed(){
        const src = 'https://www.windy.com/?temp,37.09,-77.68,8';
        return (
          <div className="rounded-lg overflow-hidden border border-slate-700/50">
            <iframe title="Windy" src={src} width="100%" height="300" loading="lazy"></iframe>
          </div>
        );
      }

      /* ------------------ App Shell ------------------ */
      function App(){
        const { lastUpdate, isRefreshing, refresh, airQuality, incidents, stations, fireWeather, drought, alerts, hotspots } = useMockData();
        return (
          <div className="min-h-screen p-4 md:p-8">
            <ThemeToggle />
            <div className="max-w-7xl mx-auto space-y-6">
              <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                  <h1 className="text-3xl md:text-4xl font-bold text-white mb-2">Five Forks Fire Weather Dashboard</h1>
                  <p className="text-slate-400">Real-time monitoring from 11 regional weather stations</p>
                </div>
                <div className="flex items-center gap-3">
                  <div className="text-right">
                    <p className="text-xs text-slate-500">Last updated</p>
                    <p className="text-sm text-slate-300 font-medium">{timeSince(lastUpdate)}</p>
                  </div>
                  <Button onClick={refresh} disabled={isRefreshing}>üîÑ Refresh</Button>
                </div>
              </header>

              <ExternalLinksBar />

              <NWSAlertBanner alerts={alerts} />

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <MetricsCard title="Active Fires" value={incidents?.length || 0} status={(incidents?.length||0)>0?'danger':'good'} description="Within ~120 miles" />
                <MetricsCard title="Temperature" value={airQuality?.temperature ?? '--'} unit="¬∞F" status={airQuality && airQuality.temperature>85?'warning':'good'} description="Regional average" />
                <MetricsCard title="Wind Speed" value={airQuality?.wind_speed ?? '--'} unit="mph" status={airQuality && airQuality.wind_speed>15?'warning':'good'} description={airQuality?.wind_direction || 'N/A'} />
                <MetricsCard title="Humidity" value={airQuality?.humidity ?? '--'} unit="%" status={airQuality && airQuality.humidity<30?'warning':'good'} />
              </div>

              <div className="grid lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-6">
                  <ActiveAlerts incidents={incidents} />
                  <MapHotspots hotspots={hotspots} />
                </div>
                <div className="space-y-6">
                  <AirQualityCard data={airQuality} />
                  <FireWeatherPanel fireWeather={fireWeather} drought={drought} />
                </div>
              </div>

              <TrendsChart />

              <div className="rounded-xl border border-slate-700/50 bg-slate-800/30 p-4">
                <Diagnostics />
              </div>
            </div>
          </div>
        );
      }

      /* ------------------ Mount ------------------ */
      const root = ReactDOM.createRoot(document.getElementById('root'));
      console.assert(!!root, 'Root mount failed');
      root.render(<App />);
    </script>
  </body>
</html>
