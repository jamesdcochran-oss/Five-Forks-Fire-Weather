<script>
  // ------------------------------ Config ------------------------------
  const BUFFER_KM = 10; // adjust as needed

  const COUNTIES = [
    // Example structure ‚Äì replace with your real list
    // { name: 'Brunswick', lat: 36.77, lon: -77.86 },
    // { name: 'Greensville', lat: 36.70, lon: -77.54 },
  ];

  // Leaflet map + layers
  let map;
  const layers = {
    base: null,
    buffers: null,
    centers: null,
    hotspots: null
  };

  // ------------------------------ Map init ------------------------------
  function initMap() {
    // Centered roughly over Southside VA; adjust as you prefer
    map = L.map('map', {
      center: [37.0, -77.4],
      zoom: 8
    });

    layers.base = L.tileLayer('YOUR_TILE_URL/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    layers.buffers = L.layerGroup().addTo(map);
    layers.centers = L.layerGroup().addTo(map);
    layers.hotspots = L.layerGroup().addTo(map);
  }

  // ------------------------------ Rendering helpers ------------------------------
  function renderCardsStart() {
    const cards = document.getElementById('cards');
    if (cards) {
      cards.innerHTML = '<p>Loading county conditions‚Ä¶</p>';
    }
    const alerts = document.getElementById('alerts');
    if (alerts) {
      alerts.hidden = true;
      alerts.textContent = '';
    }
  }

  function showAlert(msg) {
    const box = document.getElementById('alerts');
    if (!box) return;
    box.hidden = false;
    box.textContent = msg;
  }

  function renderCountyCard(county, now, hotspotCount) {
    const cards = document.getElementById('cards');
    if (!cards) return;

    const card = document.createElement('div');
    card.className = 'card';

    const h3 = document.createElement('h3');
    h3.textContent = county.name;
    card.appendChild(h3);

    const pNow = document.createElement('p');
    pNow.textContent = now
      ? `Temp: ${now.temp ?? '?'}  RH: ${now.rh ?? '?'}  Wind: ${now.wind ?? '?'}`
      : 'Weather unavailable';
    card.appendChild(pNow);

    const pHot = document.createElement('p');
    pHot.textContent = `Hotspots within ${BUFFER_KM} km: ${hotspotCount}`;
    card.appendChild(pHot);

    cards.appendChild(card);
  }

  // ------------------------------ Data fetch ------------------------------
  async function fetchFIRMS() {
    try {
      const url = 'YOUR_FIRMS_URL.geojson'; // replace with real FIRMS endpoint
      const res = await fetch(url);
      if (!res.ok) throw new Error(`FIRMS ${res.status}`);
      return await res.json();
    } catch (err) {
      console.error('FIRMS error:', err);
      showAlert('Unable to load FIRMS active fire data.');
      return null;
    }
  }

  async function fetchNOAAHourly(lat, lon) {
    try {
      // Example pattern; replace with your real NOAA/NWS logic
      const res = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
      if (!res.ok) throw new Error(`NOAA points ${res.status}`);
      const meta = await res.json();
      const hourlyUrl = meta.properties?.forecastHourly;
      if (!hourlyUrl) throw new Error('No hourly URL from NOAA');

      const hourlyRes = await fetch(hourlyUrl);
      if (!hourlyRes.ok) throw new Error(`NOAA hourly ${hourlyRes.status}`);
      const hourly = await hourlyRes.json();
      const first = hourly.properties?.periods?.[0] || null;
      if (!first) return null;

      return {
        temp: first.temperature,
        rh: first.relativeHumidity?.value ?? null,
        wind: first.windSpeed
      };
    } catch (err) {
      console.error('NOAA error:', err);
      return null;
    }
  }

  // ------------------------------ Map drawing ------------------------------
  function drawBuffersAndCenters() {
    layers.buffers.clearLayers();
    layers.centers.clearLayers();

    const circles = [];
    for (const c of COUNTIES) {
      const circle = turf.circle([c.lon, c.lat], BUFFER_KM, {
        units: 'kilometers',
        steps: 64
      });
      L.geoJSON(circle, {
        style: { color: '#22c55e', weight: 1, fillOpacity: 0.08 }
      }).addTo(layers.buffers);
      circles.push(circle);

      L.circleMarker([c.lat, c.lon], {
        radius: 5,
        color: '#0ea5e9',
        fillColor: '#0ea5e9',
        fillOpacity: 0.9
      })
        .bindTooltip(c.name)
        .addTo(layers.centers);
    }

    if (circles.length > 0) {
      const bbox = turf.bbox(turf.featureCollection(circles));
      const sw = [bbox[1], bbox[0]];
      const ne = [bbox[3], bbox[2]];
      map.fitBounds([sw, ne], { padding: [30, 30] });
    }
  }

  function drawHotspots(geojson) {
    layers.hotspots.clearLayers();
    if (!geojson?.features?.length) return;

    L.geoJSON(geojson, {
      filter: f => f && f.geometry && f.geometry.type === 'Point',
      pointToLayer: (f, latlng) => {
        const marker = L.circleMarker(latlng, {
          radius: 4,
          color: '#ef4444',
          fillColor: '#ef4444',
          fillOpacity: 0.85,
          weight: 1
        });

        const props = f.properties || {};
        const time = props.acq_date
          ? `${props.acq_date} ${props.acq_time ?? ''}`
          : (props.time ?? '');
        const instrument = props.instrument || props.satellite || '';
        const confidence = props.confidence
          ? `‚Ä¢ ${props.confidence}`
          : (props.confidence_level ? `‚Ä¢ ${props.confidence_level}` : '');
        const popup = `<strong>üî• Active fire</strong><br>${time}<br>${instrument} ${confidence}`.trim();
        marker.bindPopup(popup);
        return marker;
      }
    }).addTo(layers.hotspots);
  }

  // ------------------------------ Logic ------------------------------
  async function refresh() {
    renderCardsStart();

    const firms = await fetchFIRMS();
    if (firms) {
      drawHotspots(firms);
    }
    drawBuffersAndCenters();

    const features = firms?.features ?? [];
    for (const county of COUNTIES) {
      const now = await fetchNOAAHourly(county.lat, county.lon);
      const buffer = turf.circle([county.lon, county.lat], BUFFER_KM, {
        units: 'kilometers'
      });

      const count = features.reduce((acc, f) => {
        if (!f.geometry || f.geometry.type !== 'Point') return acc;
        const [x, y] = f.geometry.coordinates; // lon, lat
        const inside = turf.booleanPointInPolygon(
          turf.point([x, y]),
          buffer
        );
        return acc + (inside ? 1 : 0);
      }, 0);

      renderCountyCard(county, now, count);
    }

    // Self-check for Brunswick & Greensville
    const names = [...document.querySelectorAll('#cards .card h3')].map(
      h => h.textContent
    );
    if (
      !names.some(t => t.includes('Brunswick')) ||
      !names.some(t => t.includes('Greensville'))
    ) {
      showAlert('Self-check failed: Brunswick and/or Greensville not rendered.');
    } else {
      const box = document.getElementById('alerts');
      if (box) box.hidden = true;
    }
  }
</script>

<!-- Fire behavior calculator (optional external script) -->
<script src="fire-behavior.js"></script>

<script>
  // ------------------------------ Boot ------------------------------
  window.addEventListener('DOMContentLoaded', () => {
    initMap();
    refresh();
    setInterval(refresh, 60 * 60 * 1000); // hourly
  });

  // Theme toggle
  const toggle = document.getElementById('themeToggle');
  if (toggle) {
    toggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      toggle.textContent = document.body.classList.contains('dark')
        ? '‚òÄÔ∏è Light'
        : 'üåô Dark';
    });
  }
</script>
