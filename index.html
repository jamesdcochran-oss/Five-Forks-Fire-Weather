<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firm Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Required foundation for Windy API/Plugin) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Leaflet script loads L object globally -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6aR4v98e6j0b4B/hG/s/Y6c/p/s0N8O8O5T0N8O8="
        crossorigin=""></script>
    
    <!-- Use Inter font family -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { transition: all 0.2s ease-in-out; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4px, 6px, 0.05); }
        .loader { border-top-color: #3498db; }
        /* Set explicit height for the map container */
        #leaflet-map {
            height: 350px; /* Responsive height for visibility */
            z-index: 0; /* Ensure Leaflet tiles render correctly */
        }
        /* Custom class for Leaflet markers */
        .compliant-marker { background-color: #10B981; } /* Green */
        .warning-marker { background-color: #F59E0B; } /* Amber/Orange */
        .alert-marker { background-color: #EF4444; } /* Red */
        .low-score-marker { background-color: #6B7280; } /* Gray */

        .firm-marker {
            color: white; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            text-align: center; 
            line-height: 24px; 
            font-size: 10px; 
            font-weight: bold; 
            border: 3px solid white; 
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: transform 0.1s ease-out;
        }
        .firm-marker:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Environmental Oversight Dashboard</h1>
            <p class="text-sm text-gray-500 mt-1" id="user-info">
                Loading user data...
            </p>
        </header>

        <!-- Loading State -->
        <div id="loading-spinner" class="flex justify-center items-center h-48">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 animate-spin"></div>
        </div>

        <!-- Main Content Grid -->
        <div id="content-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-6" style="display: none;">

            <!-- Column 1 & 2: Stats and Alerts (Takes 2/3 width on desktop, full width on mobile) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Key Performance Indicators (KPIs) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="card bg-white p-5 rounded-xl shadow-lg border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">Total Firms Monitored</p>
                        <p class="text-3xl font-bold text-blue-600 mt-1" id="kpi-firms">0</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl shadow-lg border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">Active Alerts</p>
                        <p class="text-3xl font-bold text-red-500 mt-1" id="kpi-alerts">0</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl shadow-lg border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">Avg. Compliance Score</p>
                        <p class="text-3xl font-bold text-green-600 mt-1" id="kpi-score">--</p>
                    </div>
                </div>

                <!-- Alert List -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Firm Activity</h2>
                    <ul id="alert-list" class="space-y-3">
                        <!-- Alert items will be dynamically inserted here -->
                        <li class="p-3 bg-gray-50 rounded-lg text-gray-500 text-center text-sm">No recent activity detected.</li>
                    </ul>
                </div>
            </div>

            <!-- Column 3: Monitored Map (Takes 1/3 width on desktop, full width on mobile) -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Monitored County Coverage Map</h2>

                    <!-- Interactive Leaflet Map Container (Replaced SVG) -->
                    <div id="leaflet-map" class="w-full rounded-lg shadow-inner border border-gray-200">
                        <!-- Map will be rendered here by JavaScript -->
                    </div>

                    <div id="map-info" class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded-md text-sm">
                        Map Initializing...
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for Information (Replaces alert()) -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-3 text-gray-800">Details</h3>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <button onclick="hideModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                Close
            </button>
        </div>
    </div>


    <!-- Firebase Initialization and Logic -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Internal State Variables
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let mapInstance = null; // Store the Leaflet map instance
        let firmMarkersGroup = null; // New LayerGroup to manage all dynamic firm markers

        // Set Firebase logging level for debugging (optional, can be removed in production)
        setLogLevel('Debug');

        // --- DOM Element References ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const contentGrid = document.getElementById('content-grid');
        const userInfoEl = document.getElementById('user-info');
        const kpiFirmsEl = document.getElementById('kpi-firms');
        const kpiAlertsEl = document.getElementById('kpi-alerts');
        const kpiScoreEl = document.getElementById('kpi-score');
        const alertListEl = document.getElementById('alert-list');
        const mapInfoEl = document.getElementById('map-info');

        // --- UI Functions (Modal and Map Info) ---

        /**
         * Updates the map info box and shows the details modal.
         * @param {string} message The message to display.
         */
        window.showInfo = function(message) {
            mapInfoEl.textContent = message;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        /**
         * Hides the details modal.
         */
        window.hideModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // --- Leaflet Map Integration ---

        /**
         * Clears all existing markers from the map and renders new ones based on firm data.
         * @param {Array<Object>} firms Array of firm data objects from Firestore.
         */
        function renderFirmMarkers(firms) {
            const L = window.L;
            if (!L || !mapInstance) return;

            // 1. Clear existing markers to prevent duplication
            firmMarkersGroup.clearLayers();

            if (firms.length === 0) {
                mapInfoEl.textContent = 'Map initialized. No firm locations found.';
                return;
            }

            // Calculate center point for map view (optional, but good for starting view)
            let centerLat = 0, centerLng = 0;

            firms.forEach(firm => {
                const lat = firm.latitude;
                const lng = firm.longitude;

                // Basic validation for location data
                if (typeof lat !== 'number' || typeof lng !== 'number') {
                    console.warn(`Skipping firm ${firm.firmName}: Missing or invalid coordinates.`, firm);
                    return;
                }

                centerLat += lat;
                centerLng += lng;

                // Determine marker color based on status/score
                let colorClass = 'compliant-marker';
                let statusText = 'Compliant';

                if (firm.status === 'Alert' || firm.score < 60) {
                    colorClass = 'alert-marker';
                    statusText = 'Active Alert';
                } else if (firm.status === 'Warning' || firm.score < 80) {
                    colorClass = 'warning-marker';
                    statusText = 'Warning Watch';
                }

                // Create custom icon
                const markerHtml = `
                    <div class="firm-marker ${colorClass}">
                        ${firm.firmName.charAt(0).toUpperCase()}
                    </div>
                `;
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: markerHtml,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                // Create and add the marker to the layer group
                const marker = L.marker([lat, lng], { icon: customIcon });

                // Add popup content
                const popupContent = `
                    <h4 class="font-bold text-lg">${firm.firmName}</h4>
                    <p class="text-sm">Compliance Score: <strong>${firm.score || '--'}</strong></p>
                    <p class="text-sm">Status: <span class="font-semibold" style="color:${(colorClass.includes('alert') ? '#EF4444' : colorClass.includes('warning') ? '#F59E0B' : '#10B981')}">${statusText}</span></p>
                    <p class="text-xs mt-2 text-gray-500">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</p>
                `;
                marker.bindPopup(popupContent);
                
                // Click handler to update the info box
                marker.on('click', () => {
                    mapInfoEl.textContent = `${firm.firmName}: Score ${firm.score || '--'}, Status: ${statusText}.`;
                });

                firmMarkersGroup.addLayer(marker);
            });

            // Adjust map center if firms are present
            if (firms.length > 0) {
                 // Set view to the first firm or calculated center point
                mapInstance.setView([firms[0].latitude, firms[0].longitude], 10);
                mapInfoEl.textContent = `${firms.length} monitored firms displayed on the map.`;
            }
        }

        /**
         * Initializes the Leaflet map's static components (instance, tiles, layer group).
         * This function now runs synchronously once the page is loaded (after a slight delay).
         */
        function initializeLeafletMap() {
            // Reference the global L object
            const L = window.L;
            
            // If the library hasn't loaded by now, log an error and stop.
            if (!L || typeof L.map !== 'function') {
                console.error("Leaflet object L is not defined. Cannot initialize map.");
                mapInfoEl.textContent = 'Error: Map library failed to load core functions.';
                return;
            }

            // --- L.map is now guaranteed to be a function, proceed with static initialization ---
            
            if (mapInstance) {
                mapInstance.remove(); // Clean up previous map if it exists
            }

            // Set up the map in the dedicated div (default view)
            mapInstance = L.map('leaflet-map').setView([34.05, -118.24], 9); 

            // Add tile layer (static part)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mapInstance);

            // Initialize the layer group for dynamic markers and add it to the map
            firmMarkersGroup = L.layerGroup().addTo(mapInstance);

            // Invalidate size is crucial when layout becomes visible
            setTimeout(() => {
                mapInstance.invalidateSize();
            }, 500);

            mapInfoEl.textContent = 'Map initialized. Loading firm data...';
        }

        /**
         * Recursively checks if the Leaflet object (L) is available.
         * Calls initializeLeafletMap when ready.
         */
        function ensureLeafletIsReady() {
            const L = window.L;
            if (L && typeof L.map === 'function') {
                initializeLeafletMap();
            } else {
                // If L is not yet defined, try again on the next animation frame
                // This is a robust way to wait for external scripts without fixed timeouts
                window.requestAnimationFrame(ensureLeafletIsReady);
            }
        }

        // --- Firebase Core Setup and Authentication ---

        /**
         * Attempts to authenticate the user using a custom token or anonymously.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                userInfoEl.textContent = `Authentication Error: ${error.code}`;
                
                // On auth failure, ensure UI is displayed and try to initialize map anyway
                if (!isAuthReady) {
                    loadingSpinner.style.display = 'none';
                    contentGrid.style.display = 'grid';
                    // Start the Leaflet readiness check
                    ensureLeafletIsReady(); 
                }
            }
        }

        /**
         * Initializes Firebase and sets up the authentication state listener.
         */
        function initializeFirebase() {
            // Start the Leaflet readiness check immediately (L is defined by an external script, so we must wait for it)
            ensureLeafletIsReady(); 
            
            if (!firebaseConfig) {
                userInfoEl.textContent = "Error: Firebase config not found. Displaying static mock data.";
                
                // Fallback for non-Firebase environment
                const mockFirms = [
                    { firmName: "EcoCorp", score: 95, status: "Compliant", latitude: 34.05, longitude: -118.24, id: 'a' },
                    { firmName: "PolluChem", score: 55, status: "Alert", latitude: 34.30, longitude: -118.60, id: 'b' },
                    { firmName: "WaterFlow Inc.", score: 78, status: "Warning", latitude: 33.70, longitude: -117.90, id: 'c' },
                ];
                
                // Render mock markers (this will only work if Leaflet is ready, which is handled by ensureLeafletIsReady)
                // If Leaflet is not ready, this call will safely exit early via the check inside renderFirmMarkers.
                setTimeout(() => renderFirmMarkers(mockFirms), 100); 

                loadingSpinner.style.display = 'none';
                contentGrid.style.display = 'grid';
                kpiFirmsEl.textContent = mockFirms.length.toString();
                kpiAlertsEl.textContent = '1';
                kpiScoreEl.textContent = '76.0';

                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set up listener to handle user sign-in/sign-out state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoEl.textContent = `User ID: ${userId} | App ID: ${appId}`;

                        // Start data listeners only once authentication is confirmed
                        if (!isAuthReady) {
                            listenToFirmsKPIs();
                            listenToRecentAlerts();
                            listenToFirmsLocations(); // Start listening for dynamic map data
                            isAuthReady = true;
                            // Display UI
                            loadingSpinner.style.display = 'none';
                            contentGrid.style.display = 'grid';
                        }
                    } else {
                        // User logged out or initial state, attempt sign-in
                        userId = null;
                        authenticateUser();
                    }
                });

                // Initial authentication attempt
                authenticateUser();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userInfoEl.textContent = `Initialization Error: ${error.message}`;
                loadingSpinner.style.display = 'none';
                contentGrid.style.display = 'grid';
            }
        }

        // --- Firestore Data Listeners ---

        /**
         * Listens to the 'firms_data' collection to calculate and update KPIs.
         */
        function listenToFirmsKPIs() {
            if (!db || !userId) return;

            const firmsColRef = collection(db, 'artifacts', appId, 'users', userId, 'firms_data');

            onSnapshot(firmsColRef, (snapshot) => {
                const firms = snapshot.docs.map(doc => doc.data());
                const totalFirms = firms.length;
                
                let totalScore = 0;
                let activeAlerts = 0;

                firms.forEach(firm => {
                    // Check if score is a valid number before adding
                    totalScore += firm.score || 0;
                    if (firm.status === 'Alert') {
                        activeAlerts++;
                    }
                });

                const avgScore = totalFirms > 0 ? (totalScore / totalFirms).toFixed(1) : '--';

                // Update UI elements
                kpiFirmsEl.textContent = totalFirms.toString();
                kpiScoreEl.textContent = avgScore;
                kpiAlertsEl.textContent = activeAlerts.toString();
            }, (error) => {
                console.error("Error listening to firms_data for KPIs:", error);
            });
        }
        
        /**
         * Listens to the 'firms_data' collection to get location data and updates the map markers.
         */
        function listenToFirmsLocations() {
            if (!db || !userId) return;

            const firmsColRef = collection(db, 'artifacts', appId, 'users', userId, 'firms_data');

            onSnapshot(firmsColRef, (snapshot) => {
                const firms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Pass the new data to the marker renderer
                renderFirmMarkers(firms);

            }, (error) => {
                console.error("Error listening to firms_data for locations:", error);
                mapInfoEl.textContent = 'Error loading firm locations.';
            });
        }


        /**
         * Listens to the 'alerts' collection and renders the top 5 recent alerts.
         */
        function listenToRecentAlerts() {
            if (!db || !userId) return;

            const alertsColRef = collection(db, 'artifacts', appId, 'users', userId, 'alerts');

            onSnapshot(alertsColRef, (snapshot) => {
                let alerts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Since we avoid using orderBy() for index reasons, we sort by timestamp in memory (newest first)
                alerts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                renderAlerts(alerts.slice(0, 5)); // Display only the top 5 alerts
            }, (error) => {
                console.error("Error listening to alerts:", error);
            });
        }

        // --- UI Rendering ---

        /**
         * Clears and renders the list of recent alerts to the DOM.
         * @param {Array<Object>} alerts Array of alert documents.
         */
        function renderAlerts(alerts) {
            alertListEl.innerHTML = ''; // Clear existing alerts

            if (alerts.length === 0) {
                alertListEl.innerHTML = '<li class="p-3 bg-gray-50 rounded-lg text-gray-500 text-center text-sm">No recent activity detected.</li>';
                return;
            }

            alerts.forEach(alert => {
                const date = alert.timestamp ? new Date(alert.timestamp.toDate()) : null;
                const dateStr = date ? date.toLocaleString() : 'N/A';
                
                // Determine styling based on alert level
                const statusColor = alert.level === 'High' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';

                const li = document.createElement('li');
                li.className = `p-3 rounded-lg flex justify-between items-center border border-gray-100 ${statusColor}`;
                li.innerHTML = `
                    <div>
                        <p class="font-semibold text-base">${alert.firmName || 'Unknown Firm'}</p>
                        <p class="text-xs mt-0.5">${alert.message || 'General Alert'}</p>
                    </div>
                    <span class="text-xs whitespace-nowrap opacity-75">${dateStr}</span>
                `;
                alertListEl.appendChild(li);
            });
        }

        // --- Start Application ---
        window.onload = function() {
            initializeFirebase();
        };

    </script>
</body>
</html>
