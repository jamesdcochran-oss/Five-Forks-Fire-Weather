<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Five Forks Fire Weather ‚Äî Single File</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Favicon - Fire emoji -->
    <link rel="icon" href="flameforks.png" type="image/png">
    <link rel="apple-touch-icon" href="flameforks.png">

    <style>
      /* Five Forks Fire Weather ‚Äî Single-file build
         - Live data: NOAA (NWS) + NASA FIRMS
         - Map tiles: OpenStreetMap via Leaflet
         - Includes Brunswick & Greensville; self-check ensures both render
      */
      :root {
        --bg:#f9fafb;
        --card:#ffffff;
        --muted:#6b7280;
        --shadow:0 2px 6px rgba(0,0,0,.08);
        --ok:#16a34a;
        --warn:#d97706;
        --err:#dc2626;
        --neutral:#475569;
        --header-bg:#1d4ed8;
      }

      /* Dark mode overrides */
      body.dark {
        --bg:#020617;
        --card:#020617;
        --muted:#9ca3af;
        --neutral:#e5e7eb;
        --header-bg:#020617;
        color:#e5e7eb;
      }
      body.dark .badge{
        background:#111827;
        color:var(--neutral);
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0f172a}

      .app-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:.75rem 1rem;
        background:var(--header-bg);
        color:#fff;
      }
      .app-header h1{margin:0;font-size:1.25rem}
      .quick-links{display:flex;gap:.5rem;align-items:center}
      .badge{
        background:#fff;color:var(--header-bg);padding:.3rem .6rem;border-radius:999px;font-weight:600;border:none;cursor:pointer;
        box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:.35rem;text-decoration:none;
      }

      main{padding:1rem;display:grid;gap:1rem}
      .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
      .card{background:var(--card);padding:1rem;border-radius:10px;box-shadow:var(--shadow)}
      .card h3{margin:.25rem 0 .35rem}
      .dim{color:var(--muted);margin-bottom:.35rem}

      .map-wrap{height:520px;border-radius:10px;overflow:hidden}
      #map{height:100%}

      .app-footer{padding:1rem;background:transparent}
      .statusbar .badge{background:transparent;color:var(--neutral);box-shadow:none;padding:.18rem .45rem}

      /* small screens */
      @media (max-width:768px){
        .app-header{flex-direction:column;gap:.75rem;padding:1rem}
        .app-header h1{font-size:1.5rem;text-align:center}
        .quick-links{justify-content:center;width:100%}
        .quick-links .badge{font-size:.75rem;padding:.2rem .4rem}
        main{padding:.75rem;gap:.75rem}
        .cards{grid-template-columns:1fr;gap:.75rem}
        .card{padding:.75rem}
        .map-wrap{height:300px;margin-bottom:1rem}
        .app-footer{padding:.5rem;font-size:.85rem}
        .statusbar{flex-wrap:wrap;gap:.35rem;justify-content:center}
        .statusbar .badge{font-size:.7rem;padding:.2rem .4rem}
      }
      @media (min-width:960px){
        main{grid-template-columns:1.2fr 1fr;align-items:start}
        .map-wrap{grid-row:span 2}
      }

      /* Simple modal styling for the calculator */
      #fuelCalcModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; }
      #fuelCalcModal .modal-content { background:#fff;color:#000;padding:1rem;max-width:900px;width:95%;max-height:90%;overflow:auto;border-radius:8px;position:relative; }
      #fuelCalcModal .modal-content h2 { margin-top:0; }
      #fuelCalcModal .modal-close { position:absolute; right:.5rem; top:.5rem; background:transparent; border:none; font-size:1.2rem; cursor:pointer; }
      #resultsTable table { width:100%; border-collapse:collapse; }
      #resultsTable th, #resultsTable td { padding:.25rem .5rem; text-align:left; border-bottom:1px solid #eee }
      
      /* Ensure Leaflet controls are visible above other map elements */
      .leaflet-control-container { z-index: 1000; }
      .leaflet-control { z-index: 1000; }
    </style>
  </head>
  <body>
    <header class="app-header">
      <h1>üî• Five Forks Fire Weather</h1>
      <div class="quick-links">
        <a href="https://firms.modaps.eosdis.nasa.gov/map/" target="_blank" class="badge" style="text-decoration:none">üõ∞Ô∏è FIRMS</a>
        <a href="https://www.weather.gov/akq/" target="_blank" class="badge" style="text-decoration:none">üåßÔ∏è NWS</a>
        <a href="https://maps.app.goo.gl/vcWebUQrrLSY8gX4A" target="_blank" class="badge" style="text-decoration:none">üó∫Ô∏è Equip</a>
        <a href="https://www.windy.com/?37.233,-77.400,8" target="_blank" class="badge" style="text-decoration:none">üå™Ô∏è Windy</a>

        <!-- Button that opens the embedded calculator modal -->
        <button id="openFuelCalc" class="badge" style="text-decoration:none">üßÆ Fuel Moisture</button>

        <!-- Keep link to GitHub repo as well (optional) -->
        <a href="https://github.com/jamesdcochran-oss/fuel-moisture-calculator" target="_blank" rel="noopener" class="badge" style="text-decoration:none">
          <img src="https://img.shields.io/badge/Fuel%20Moisture-Calculator-blue" alt="Fuel Moisture Calculator" style="height:1.2rem">
        </a>

        <button id="themeToggle" class="badge">üåô Dark</button>
      </div>
    </header>

    <main>
      <section id="cards" class="cards" aria-label="County conditions"></section>

      <section class="map-wrap" aria-label="Hotspots map">
        <div id="map"></div>
      </section>

      <section id="alerts" class="alerts" aria-live="polite" hidden></section>
    </main>

    <footer class="app-footer">
      <div class="statusbar" style="text-align:center;margin-bottom:0.5rem" aria-live="polite">
        <span id="status-noaa" class="badge" title="NOAA Weather API">NOAA ‚è≥</span>
        <span id="status-firms" class="badge" title="NASA FIRMS GeoJSON">FIRMS ‚è≥</span>
        <span id="status-tiles" class="badge" title="Map tiles (OSM)">Tiles ‚è≥</span>
      </div>
      <small>Data: NOAA NWS & NASA FIRMS ¬∑ Auto-refresh hourly</small>
    </footer>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Include the calculator script so wireUI and functions are available -->
    <script src="fuel-calculator.js"></script>

    <!-- Inline app logic (unchanged core behavior) -->
    <script>
      /**
       * Single-file app logic
       * - Verifies connectivity (badges) for NOAA, FIRMS, OSM tiles
       * - Draws hotspots + 30 km buffers + county centers
       * - Builds cards per county using NOAA hourly forecast
       */

      // ----------------------------- Config ---------------------------------
      const COUNTIES = [
        { name: "Amelia",        lat: 37.342, lon: -77.980 },
        { name: "Nottoway",      lat: 37.142, lon: -78.089 },
        { name: "Dinwiddie",     lat: 37.077, lon: -77.587 },
        { name: "Prince George", lat: 37.221, lon: -77.288 },
        { name: "Brunswick",     lat: 36.758, lon: -77.847 },
        { name: "Greensville",   lat: 36.686, lon: -77.542 },
      ];

      const BUFFER_KM = 30; // conservative proximity window for nearby hotspots

      // Precompute Turf buffers for performance (instead of computing in the loop)
      const COUNTY_BUFFERS = COUNTIES.map(c => ({
        county: c,
        buffer: turf.circle([c.lon, c.lat], BUFFER_KM, { units: 'kilometers' })
      }));

      // FIRMS endpoint referenced in the original file (appears to be geojson)
      const FIRMS_URL = "https://firms.modaps.eosdis.nasa.gov/api/area/csv/6ec6f9501dda0774853f77ee933238ed/VIIRS_NOAA20_NRT/-78.5,36.0,-77,37.5/1";

      // --------------------------- Status Helpers ----------------------------
      function setBadge(id, state, label){
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('ok','warn','err');
        if (state) el.classList.add(state);
        if(label) el.textContent = label;
      }
      function showAlert(msg){ const box = document.getElementById('alerts'); if(!box) return; box.hidden = false; box.textContent = msg; }

      // ----------------------------- Map Init --------------------------------
      let map, layers = {};
      function initMap(){
        map = L.map('map');
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        layers = {
          hotspots: L.layerGroup().addTo(map),
          buffers: L.layerGroup().addTo(map),
          centers: L.layerGroup().addTo(map)
        };

        map.setView([37.0, -77.5], 8);
        // legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
          const div = L.DomUtil.create('div', 'legend');
          div.style.background = 'white';
          div.style.padding = '8px';
          div.style.borderRadius = '8px';
          div.style.boxShadow = '0 2px 6px rgba(0,0,0,.08)';
          div.innerHTML = `
            <div class="row"><span class="swatch" style="background:#ef4444"></span>Hotspot</div>
            <div class="row"><span class="swatch" style="background:#22c55e"></span>30 km buffer</div>
            <div class="row"><span class="swatch" style="background:#0ea5e9"></span>County center</div>`;
          return div;
        };
        legend.addTo(map);
      }

      // --------------------------- Data Fetching -----------------------------
      async function fetchFIRMS(){
        try {
          const res = await fetch(FIRMS_URL, { cache: 'no-store' });
          if(!res.ok) throw new Error(`FIRMS status ${res.status}`);
          const text = await res.text();

          // Try JSON first (geojson endpoint expected)
          try {
            const geojson = JSON.parse(text);
            if (geojson && Array.isArray(geojson.features)) {
              const features = geojson.features.filter(f => f.geometry && f.geometry.type === 'Point');
              setBadge('status-firms','ok','FIRMS ‚úÖ');
              return { type:'FeatureCollection', features };
            }
          } catch (e) {
            // fallback to CSV parsing if not JSON
          }

          // attempt CSV parse (very simple)
          const lines = text.trim().split('\n');
          const features = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',');
            const lat = parseFloat(cols[1]);
            const lon = parseFloat(cols[2]);
            if (Number.isFinite(lat) && Number.isFinite(lon)) {
              features.push({
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [lon, lat] },
                properties: {}
              });
            }
          }
          setBadge('status-firms','ok','FIRMS ‚úÖ');
          return { type:'FeatureCollection', features };
        } catch (e) {
          console.warn('FIRMS fetch failed', e);
          setBadge('status-firms','err','FIRMS ‚ùå');
          return { type:'FeatureCollection', features: [] };
        }
      }

      // NOAA: include User-Agent (per api.weather.gov guidance). Replace contact URL/email as appropriate.
      const NOAA_HEADERS = {
        'Accept': 'application/geo+json',
        'User-Agent': 'Five-Forks-Fire-Weather (https://github.com/jamesdcochran-oss/Five-Forks-Fire-Weather)'
      };

      async function fetchNOAAHourly(lat, lon){
        try {
          const p = await fetch(`https://api.weather.gov/points/${lat},${lon}`, { headers: NOAA_HEADERS });
          if(!p.ok) throw new Error(`points status ${p.status}`);
          const meta = await p.json();
          const hourlyUrl = meta?.properties?.forecastHourly;
          if(!hourlyUrl) throw new Error('missing forecastHourly');
          const f = await fetch(hourlyUrl, { cache: 'no-store', headers: NOAA_HEADERS });
          if(!f.ok) throw new Error(`hourly status ${f.status}`);
          const hourly = await f.json();
          setBadge('status-noaa','ok','NOAA ‚úÖ');
          return hourly?.properties?.periods?.[0] ?? null;
        } catch(e) {
          console.warn('NOAA fetch failed', e);
          setBadge('status-noaa','warn','NOAA ‚ö†Ô∏è'); // continue rendering with N/A
          return null;
        }
      }

      // --------------------------- Rendering ---------------------------------
      function renderCardsStart(){ document.getElementById('cards').innerHTML = ''; }

      function renderCountyCard({ name }, now, hotspotCount){
        const el = document.createElement('article');
        el.className = 'card';
        const summary = now ? `${now.temperature}\u00B0F ‚Ä¢ ${now.relativeHumidity?.value ?? 'N/A'}% RH ‚Ä¢ ${now.windSpeed ?? 'N/A'} ${now.windDirection ?? ''}` : 'N/A';
        const label   = now?.shortForecast ?? 'N/A';
        el.innerHTML = `
          <h3>${label.includes('Thunder') ? '‚õàÔ∏è' : 'üå§Ô∏è'} ${name}</h3>
          <div class="dim">Class: ${label}</div>
          <div class="metric">Wx: ${summary}</div>
          <div class="metric">Hotspots (‚â§ ${BUFFER_KM} km): <strong>${hotspotCount}</strong></div>
        `;
        document.getElementById('cards').appendChild(el);
      }

      function drawBuffersAndCenters(){
        layers.buffers.clearLayers();
        layers.centers.clearLayers();

        for(const c of COUNTIES){
          const circle = turf.circle([c.lon, c.lat], BUFFER_KM, { units: 'kilometers', steps: 64 });
          const coords = turf.getCoords(circle)[0][0];
          const center = L.circle([c.lat, c.lon], { color: '#22c55e', radius: BUFFER_KM * 1000, weight: 1, fillOpacity: 0.05 });
          layers.buffers.addLayer(center);
          const marker = L.circleMarker([c.lat, c.lon], { radius:6, fillColor:'#0ea5e9', color:'#0ea5e9', weight:1, fillOpacity:1 });
          layers.centers.addLayer(marker);
        }
      }

      function drawHotspots(firms){
        layers.hotspots.clearLayers();
        const features = firms?.features ?? [];
        features.forEach(f => {
          const [lon, lat] = f.geometry.coordinates;
          const marker = L.circleMarker([lat, lon], { radius:4, fillColor:'#ef4444', color:'#ef4444', weight:1, fillOpacity:0.9 });
          layers.hotspots.addLayer(marker);
        });
      }

      // ------------------------------ Logic ----------------------------------
      async function refresh(){
        renderCardsStart();
        const firms = await fetchFIRMS();
        drawHotspots(firms);
        drawBuffersAndCenters();

        const features = firms?.features ?? [];
        for(const { county, buffer } of COUNTY_BUFFERS){
          const now = await fetchNOAAHourly(county.lat, county.lon);
          // Use precomputed buffer instead of computing on each iteration
          const count = features.reduce((acc, f) => {
            if(!f.geometry || f.geometry.type !== 'Point') return acc;
            const [x,y] = f.geometry.coordinates; // lon, lat
            if(!Number.isFinite(x) || !Number.isFinite(y)) return acc;
            const pt = turf.point([x,y]);
            if (turf.booleanPointInPolygon(pt, buffer)) return acc + 1;
            return acc;
          }, 0);
          renderCountyCard(county, now, count);
        }
      }

      // -------------------------- Init & Auto-refresh ------------------------
      document.addEventListener('DOMContentLoaded', () => {
        initMap();
        refresh().catch(e => console.warn('initial refresh failed', e));
        // auto-refresh hourly
        setInterval(() => refresh().catch(e => console.warn('refresh failed', e)), 60 * 60 * 1000);

        // theme toggle wiring
        const toggle = document.getElementById('themeToggle');
        if (toggle) {
          toggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            toggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
          });
        }
      });
    </script>

    <!-- Embedded Fuel Moisture Calculator modal (modal markup already included above in the page) -->
    <!-- Modal HTML is included in this page at top; wiring below ensures open/close and wireUI runs. -->

    <!-- Modal open/close and wiring script -->
    <script>
      // Track the element that opened the modal for focus restoration
      let modalOpener = null;

      // Helper to get all focusable elements within the modal
      function getFocusableElements(container) {
        const selector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
        return Array.from(container.querySelectorAll(selector)).filter(el => !el.disabled);
      }

      // Focus trap handler
      function trapFocus(event) {
        const modal = document.getElementById('fuelCalcModal');
        if (!modal || modal.style.display === 'none') return;
        
        const modalContent = modal.querySelector('.modal-content');
        if (!modalContent) return;
        
        const focusableElements = getFocusableElements(modalContent);
        if (focusableElements.length === 0) return;
        
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        if (event.key === 'Tab') {
          if (event.shiftKey) {
            // Shift+Tab: if on first element, go to last
            if (document.activeElement === firstElement) {
              event.preventDefault();
              lastElement.focus();
            }
          } else {
            // Tab: if on last element, go to first
            if (document.activeElement === lastElement) {
              event.preventDefault();
              firstElement.focus();
            }
          }
        }
      }

      // Close modal and restore focus
      function closeModal() {
        const modal = document.getElementById('fuelCalcModal');
        if (!modal) return;
        
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        
        // Remove focus trap listener
        document.removeEventListener('keydown', trapFocus);
        document.removeEventListener('keydown', handleEscapeKey);
        
        // Restore focus to the opener button
        if (modalOpener) {
          modalOpener.focus();
          modalOpener = null;
        }
      }

      // Handle Escape key to close modal
      function handleEscapeKey(event) {
        if (event.key === 'Escape') {
          closeModal();
        }
      }

      // Open modal and ensure the calculator UI wiring runs
      document.addEventListener('DOMContentLoaded', () => {
        const openBtn = document.getElementById('openFuelCalc');
        if (openBtn) {
          openBtn.addEventListener('click', () => {
            const modal = document.getElementById('fuelCalcModal');
            if (!modal) return;
            
            // Save the opener for focus restoration
            modalOpener = openBtn;
            
            // Show modal
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            
            // Wire UI using namespaced API
            try {
              if (window.FuelMoistureCalculator && typeof window.FuelMoistureCalculator.wireUI === 'function') {
                window.FuelMoistureCalculator.wireUI();
              }
            } catch (e) {
              console.warn('wireUI error', e);
            }
            
            // Set focus to modal content
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
              modalContent.focus();
            }
            
            // Add focus trap listener
            document.addEventListener('keydown', trapFocus);
            
            // Add Escape key listener
            document.addEventListener('keydown', handleEscapeKey);
          });
        }

        // Close modal button
        const closeBtn = document.getElementById('modalCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }

        // Close modal by clicking outside content
        const modal = document.getElementById('fuelCalcModal');
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'fuelCalcModal') {
              closeModal();
            }
          });
        }
      });
    </script>

    <!-- Fuel Moisture Calculator modal DOM (placed near end so it's available for the wiring script above) -->
    <div id="fuelCalcModal" role="dialog" aria-modal="true" aria-labelledby="fuelCalcTitle" aria-hidden="true">
      <div class="modal-content" tabindex="-1">
        <button id="modalCloseBtn" class="modal-close" aria-label="Close modal">‚úñ</button>
        <div id="fuelCalcUI" style="padding-top:1.5rem;">
          <h2 id="fuelCalcTitle">Fuel Moisture Calculator</h2>

          <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:0.75rem;">
            <label>Initial 1‚Äëhr: <input id="initial1hr" type="number" value="8" style="width:4rem"></label>
            <label>Initial 10‚Äëhr: <input id="initial10hr" type="number" value="10" style="width:4rem"></label>
          </div>

          <table id="forecastDays" style="width:100%;border-collapse:collapse;margin-bottom:.5rem;"></table>

          <div style="margin-bottom:.5rem;">
            <button id="runModelBtn" class="badge" style="cursor:pointer">Run Model</button>
          </div>

          <div id="resultsSection" style="display:none;">
            <div id="warningMessage" style="color:#b91c1c;margin-bottom:.5rem;display:none"></div>
            <div id="resultsTable" style="overflow:auto;"></div>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
