<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Five Forks Fire Weather Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    /* Custom styles for dark map appearance and hotspot pulse */
    html, body, #root { height: 100%; min-height: 100vh; margin: 0; }
    #map { height: 400px; width: 100%; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

    /* Leaflet dark mode styling for controls and attribution */
    .leaflet-control-attribution,
    .leaflet-popup-content-wrapper,
    .leaflet-control-zoom {
      filter: invert(100%) hue-rotate(180deg) brightness(90%) contrast(100%);
    }
    /* Ensure the actual tiles are not double-inverted */
    .leaflet-tile-container {
      filter: none !important;
    }
    .leaflet-popup-content-wrapper {
      background: #1f2937; /* slate-800 */
      color: #e5e7eb; /* slate-200 */
      border-radius: 0.5rem;
    }
    .leaflet-popup-tip { background: #1f2937; }

    .fire-icon-div {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 0.8; }
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans">
  <div id="root" class="min-h-screen"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const L = window.L; // Reference Leaflet globally

    // Target counties in Virginia, centered around Five Forks area
    const COUNTIES = [
      { name: "Amelia", lat: 37.32646, lon: -77.99537, wul: "amelia-court-house" },
      { name: "Nottoway", lat: 37.14824, lon: -78.03382, wul: "blackstone" },
      { name: "Brunswick", lat: 36.78112, lon: -77.85049, wul: "brodnax" },
      { name: "Dinwiddie", lat: 37.02153, lon: -77.60261, wul: "dinwiddie" },
      { name: "Greensville", lat: 36.6413, lon: -77.56347, wul: "emporia" },
      { name: "Prince George", lat: 37.1881, lon: -77.18101, wul: "prince-george" }
    ]; 

    // --- Data Fetching Hook ---

    function useWeatherData() {
      const [counties, setCounties] = useState(COUNTIES.map(c => ({ ...c, temp: null, rh: null, wind: null, gust: null, dew: null, aqi: null, is3030: false })));
      const [hotspots, setHotspots] = useState([]);
      const [nwsAlerts, setNwsAlerts] = useState([]);
      const [criticalAlert, setCriticalAlert] = useState(null);
      const [loading, setLoading] = useState(true);
      const [errors, setErrors] = useState([]);

      // Helper for fetching data with error handling
      const safeFetch = async (url, desc, headers = {}) => {
        try {
          const res = await fetch(url, { headers });
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          // Special handling for CSV (NASA FIRMS)
          const contentType = res.headers.get('content-type');
          // FIX: Replaced optional chaining with explicit null check for Babel 6 compatibility
          if ((contentType && contentType.includes('text/csv')) || url.includes('csv')) {
            return await res.text();
          }
          return await res.json();
        } catch (e) {
          console.error(`${desc} failed:`, e);
          setErrors(errs => [...errs, `${desc} failed: ${e.message}`]);
          return null;
        }
      };

      // Fetches active fire incidents from NASA FIRMS (Virginia filter applied after fetch)
      const fetchHotspots = async () => {
        const csvUrl = "https://firms.modaps.eosdis.nasa.gov/api/country/csv/USA/MODIS_NRT/24h";
        const csvText = await safeFetch(csvUrl, "NASA FIRMS Hotspots");

        if (csvText) {
          const [head, ...rows] = csvText.trim().split("\n");
          if (rows.length === 0) return;

          const keys = head.split(",").map(k => k.trim());
          
          const fireData = rows
            .map(row => {
              const values = row.split(",").map(v => v.trim());
              if (values.length !== keys.length) return null;
              const item = values.reduce((acc, val, idx) => {
                acc[keys[idx]] = val;
                return acc;
              }, {});

              // Filter for Virginia (VA)
              if (item.state === "Virginia") {
                return {
                  lat: parseFloat(item.latitude),
                  lon: parseFloat(item.longitude),
                  conf: item.confidence,
                  ts: `${item.acq_date} ${item.acq_time}`
                };
              }
              return null;
            })
            .filter(Boolean);

          setHotspots(fireData);
        }
      };

      // Fetches active fire weather alerts from NWS for Virginia
      const fetchAlerts = async () => {
        const data = await safeFetch(
          "https://api.weather.gov/alerts/active?area=VA",
          "NWS Alerts",
          { Accept: "application/geo+json" }
        );
        if (data && data.features) {
          // Filter for Red Flag Warning, Fire Weather Watch, etc.
          const fireAlerts = data.features.filter(a =>
            a.properties.event.toLowerCase().includes("fire weather") ||
            a.properties.event.toLowerCase().includes("red flag warning")
          );
          setNwsAlerts(fireAlerts);
        }
      };

      // Simulates realistic county-specific weather data, including 30/30/30 check
      const simulateCountyData = (county) => {
        const time = new Date().getHours();
        const isDaytime = time >= 10 && time <= 18; // 10am to 6pm

        let baseTemp = 75 + Math.random() * 5;
        let baseRH = 35 + Math.random() * 5; 
        let baseWind = 8 + Math.random() * 5;

        // General Daytime Fire Risk Adjustments
        if (isDaytime) {
          baseTemp += 5; 
          baseRH -= 10; 
          baseWind += 5;
        }

        // 15% chance to randomly generate critical 30/30/30 conditions for demo
        if (Math.random() < 0.15) { 
          baseTemp = 87 + Math.random() * 3; // > 86F
          baseRH = 25 + Math.random() * 5; // < 30%
          baseWind = 18 + Math.random() * 5; // > 18 mph
        }

        const temp = Math.round(baseTemp);
        const rh = Math.round(baseRH);
        const wind = Math.round(baseWind);
        const gust = Math.round(wind + Math.random() * 10);
        const dew = Math.round(temp - ((100 - rh) / 5)); // Simple dew point approximation
        const aqi = Math.round(40 + Math.random() * 20); // AQI simulation

        // 30/30/30 Rule: Temp >= 86 AND RH <= 30 AND Wind >= 18
        const is3030 = (temp >= 86) && (rh <= 30) && (wind >= 18);

        return { temp, rh, wind, gust, dew, aqi, is3030 };
      };

      useEffect(() => {
        let cancelled = false;

        const loadAllData = async () => {
          setLoading(true);
          setErrors([]); // Clear previous errors

          await Promise.all([
            fetchHotspots(),
            fetchAlerts()
          ]);

          if (cancelled) return;

          // Simulate and check county data
          const updatedCounties = COUNTIES.map(c => ({
            ...c,
            ...simulateCountyData(c),
          }));

          setCounties(updatedCounties);

          // Set app-level critical alert based on 30/30/30
          const matching = updatedCounties.filter(c => c.is3030);
          if (matching.length) {
            const countyNames = matching.map(x => x.name).join(", ");
            setCriticalAlert(`⚠️ **CRITICAL FIRE WEATHER (30/30/30 Crossover):** Conditions met in ${countyNames}. High risk of rapid fire spread.`);
          } else {
            setCriticalAlert(null);
          }

          setLoading(false);
        };

        loadAllData();
        // Auto-refresh data every 5 minutes
        const intervalId = setInterval(loadAllData, 5 * 60 * 1000);

        return () => {
          cancelled = true;
          clearInterval(intervalId);
        };
      }, []);

      return { counties, hotspots, nwsAlerts, criticalAlert, loading, errors };
    }

    // --- UI Components ---

    function LoadingOrError({ loading, errors, hotspotCount }) {
      if (loading) {
        return <div className="text-center p-4 text-slate-400">Loading real-time data...</div>;
      }
      if (errors.length) {
        return (
          <div className="bg-red-800 text-red-100 p-3 rounded-lg my-4 text-sm">
            <strong>Data Errors:</strong> {errors.join("; ")}
          </div>
        );
      }
      if (hotspotCount === 0) {
        return <div className="text-center p-4 text-green-400 font-semibold">✅ No active hotspots detected in Virginia (24h).</div>
      }
      return null;
    }

    function AlertPanel({ alerts }) {
      const fireAlerts = alerts.filter(a => a.properties.severity !== "Minor");

      if (fireAlerts.length === 0) {
        return <div className="bg-green-800/20 text-green-400 p-3 rounded-xl border border-green-700 font-medium mb-6">No active NWS Fire Weather Alerts for the region.</div>;
      }

      return (
        <div className="bg-orange-800/40 border border-orange-600 p-4 rounded-xl shadow-lg mb-6">
          <h2 className="text-xl font-bold text-orange-200 mb-2 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8.257 3.099c.765-1.364 2.766-1.364 3.531 0l3.758 6.643a2 2 0 01-.877 2.215l-3.23 1.732a2 2 0 01-1.896 0l-3.23-1.732a2 2 0 01-.877-2.215l3.758-6.643zM10 12a1 1 0 100-2 1 1 0 000 2zm0 4a1 1 0 100-2 1 1 0 000 2z" clipRule="evenodd" /></svg>
            NWS Fire Weather Alerts ({fireAlerts.length})
          </h2>
          <ul className="space-y-2 text-sm">
            {fireAlerts.map((a, i) => (
              <li key={i} className="bg-orange-900 p-3 rounded text-orange-100 border-l-4 border-yellow-400">
                <strong className="block text-yellow-300">{a.properties.event}</strong>
                <span className="text-xs italic text-orange-300 block">
                  Issued: {new Date(a.properties.sent).toLocaleTimeString()} | Expires: {new Date(a.properties.ends).toLocaleDateString()}
                </span>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    function MapHotspots({ hotspots }) {
      const mapRef = useRef(null);
      const markerGroupRef = useRef(null);
      const initialCenter = [37.17, -77.7]; // Center of the area

      useEffect(() => {
        if (!L) return;

        if (!mapRef.current) {
          // Initialize map
          const map = L.map('map').setView(initialCenter, 9);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> | FIRMS NASA',
            maxZoom: 18
          }).addTo(map);

          // Apply dark mode filter to tiles
          const tilePane = map.getPane('tilePane');
          if (tilePane) {
            tilePane.style.filter = 'invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)';
          }

          mapRef.current = map;
          markerGroupRef.current = L.layerGroup().addTo(map);
        }

        const map = mapRef.current;
        const markerGroup = markerGroupRef.current;
        markerGroup.clearLayers();

        // Add markers for real hotspots
        if (hotspots && hotspots.length > 0) {
          const fireIcon = L.divIcon({
            className: 'fire-icon-div',
            html: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#ef4444" width="24px" height="24px"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 102 0V8a1 1 0 00-.445-.832l-1.555-.832zM11 15a1 1 0 10-2 0 1 1 0 002 0z" clip-rule="evenodd" /></svg>',
            iconSize: [24, 24],
            iconAnchor: [12, 24]
          });
          
          hotspots.forEach(hs => {
            L.marker([hs.lat, hs.lon], { icon: fireIcon }).addTo(markerGroup)
              .bindPopup(`
                <strong class="text-red-400">NASA Thermal Hotspot</strong><br/>
                Confidence: <b>${hs.conf}</b><br/>
                Time: ${hs.ts}
              `);
          });
        }
      }, [hotspots]);

      return (
        <div className="p-4 bg-slate-800 rounded-xl shadow-2xl">
          <h2 className="text-xl font-bold text-red-400 mb-3 border-b border-slate-700 pb-2">Fire Hotspots (NASA FIRMS, VA, 24h)</h2>
          <div id="map" className="my-4"></div>
          <p className="text-xs text-slate-500 text-center">Satellite-detected thermal anomalies. Check confidence levels.</p>
        </div>
      );
    }

    function CountyCard({ county }) {
      // Determine alert level and styling
      let colorClass = 'bg-slate-700 border-slate-600 hover:shadow-lg';
      let statusText = 'Normal';

      if (county.is3030) {
        colorClass = 'bg-red-900 border-red-500 ring-4 ring-red-500/50 animate-pulse';
        statusText = 'CRITICAL (30/30/30)';
      } else if (county.rh <= 35 || county.wind >= 15) {
        colorClass = 'bg-yellow-900 border-yellow-500 hover:shadow-xl';
        statusText = 'Elevated Risk';
      }
      
      // Utility function to determine AQI color
      const getAqiColor = (aqi) => {
        if (aqi <= 50) return 'bg-green-700';
        if (aqi <= 100) return 'bg-yellow-700';
        return 'bg-orange-700';
      }

      return (
        <div className={`flex flex-col rounded-xl p-4 transition duration-300 border-2 ${colorClass}`}>
          <div className="flex justify-between items-center mb-2">
            <h3 className="text-xl font-extrabold text-white">{county.name}</h3>
            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${county.is3030 ? 'bg-red-500 text-white' : 'bg-slate-500 text-slate-200'}`}>
              {statusText}
            </span>
          </div>
          <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-sm text-slate-300">
            <p><strong className="text-red-300">T:</strong> {county.temp}°F</p>
            <p><strong className="text-blue-300">RH:</strong> {county.rh}%</p>
            <p><strong className="text-teal-300">Wind:</strong> {county.wind} mph</p>
            <p><strong className="text-teal-300">Gust:</strong> {county.gust} mph</p>
          </div>
          <div className="mt-3 pt-3 border-t border-slate-700 flex justify-between items-center">
            <span className={`text-xs font-bold px-2 py-1 rounded ${getAqiColor(county.aqi)}`}>
              AQI: {county.aqi}
            </span>
            <a href={`https://www.wunderground.com/weather/us/va/${county.wul}`} target="_blank" className="text-sm font-medium text-blue-400 hover:text-blue-300 transition-colors underline">
              Full Weather (WU)
            </a>
        </div>
        </div>
      );
    }

    function App() {
      const { counties, hotspots, nwsAlerts, criticalAlert, loading, errors } = useWeatherData();

      return (
        <div className="max-w-7xl mx-auto px-4 py-8">
          <header className="mb-8 border-b border-slate-700 pb-4">
            <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-500 mb-1">
              Virginia Fire Weather Dashboard
            </h1>
            <p className="text-slate-400">Monitoring Amelia, Nottoway, Brunswick, Dinwiddie, Greensville, and Prince George Counties (VA).</p>
            <p className="text-xs text-slate-500 mt-2">Data refreshes automatically every 5 minutes.</p>
          </header>

          {/* Critical Alert Message */}
          {criticalAlert && (
            <div className="bg-red-700 text-yellow-200 p-4 rounded-xl shadow-2xl mb-6 font-extrabold text-lg border-2 border-yellow-400" dangerouslySetInnerHTML={{ __html: criticalAlert.replace(/\*\*(.*?)\*\*/g, '<span>$1</span>') }} />
          )}
          
          {/* NWS Alerts */}
          <AlertPanel alerts={nwsAlerts} />

          {/* Data Status */}
          <LoadingOrError loading={loading} errors={errors} hotspotCount={hotspots.length} />

          {/* County Cards & Map Section */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* County Cards Column */}
            <div className="lg:col-span-1">
              <h2 className="text-2xl font-bold text-yellow-300 mb-4">Local Conditions & Metrics </h2>
              <div className="space-y-4">
                {counties.map((c,i)=><CountyCard key={i} county={c} />)}
              </div>
            </div>

            {/* Map Column */}
            <div className="lg:col-span-2">
              <MapHotspots hotspots={hotspots} />
            </div>
          </div>

          {/* Resource Links */}
          <div className="mt-8 pt-6 border-t border-slate-800">
            <h2 className="text-2xl font-bold text-blue-400 mb-4">Official Resources & Tools</h2>
            <div className="flex flex-wrap gap-4">
              <a href="https://www.windy.com" target="_blank" className="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded-lg font-medium transition shadow-md">
                Windy.com (Advanced Wind Maps)
              </a>
              <a href="https://www.weather.gov/akq/" target="_blank" className="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded-lg font-medium transition shadow-md">
                Wakefield NWS (Local Forecast Office)
              </a>
              <a href="https://www.airnow.gov/" target="_blank" className="bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg font-medium transition shadow-md">
                AirNow (Regional Air Quality)
              </a>
            </div>
          </div>
        </div>
      );
    }
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
