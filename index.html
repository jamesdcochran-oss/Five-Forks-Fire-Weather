<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Five Forks Fire Weather</title>
<link rel="preconnect" href="https://api.weather.gov">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{color-scheme:light dark;--bg:#0b0b0c;--fg:#eaeaea;--sub:#9aa0a6;--chip:#1b1b1c}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
header,main,footer{max-width:960px;margin:0 auto;padding:16px}
section{background:#111;padding:16px;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.25);margin:16px 0}
.kv{display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:8px 0}
.kv span{color:var(--sub)} .note{color:var(--sub)} .badge{padding:8px 12px;border-radius:999px;background:var(--chip);display:inline-block}
a{color:#8ab4f8;text-decoration:none} a:hover{text-decoration:underline}
#map{height:300px;border-radius:12px;margin-top:8px}
button{border:1px solid #333;background:#161616;color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>Five Forks Fire Weather</h1>
  <button id="refreshBtn">Refresh</button>
</header>

<main>
  <section>
    <h2>NWS Alerts</h2>
    <ul id="alerts"><li>Loading...</li></ul>
  </section>

  <section>
    <h2>Current Conditions</h2>
    <div class="kv"><span>Temperature</span><b id="temp">—</b></div>
    <div class="kv"><span>Wind</span><b id="wind">—</b></div>
    <div class="kv"><span>Relative Humidity</span><b id="rh">—</b></div>
    <div class="kv"><span>Observed</span><b id="obsTime">—</b></div>
  </section>

  <section>
    <h2>Local Danger Class</h2>
    <p id="danger" class="badge">—</p>
    <small class="note" id="dangerMeta"></small>
  </section>

  <section>
    <h2>Fire Hotspots (Local GeoJSON)</h2>
    <div id="map"></div>
    <small class="note">Source: assets/data/hotspots.geojson</small>
  </section>

  <section>
    <h2>Air Quality</h2>
    <iframe title="AirNow AQI" width="320" height="210" style="border:0;max-width:100%"
      src="https://widget.airnow.gov/aq-dial-widget/?z=23847&n=Five%20Forks%20District"></iframe>
  </section>
</main>

<footer><small>Built for Five Forks District • NWS + AirNow + Local GeoJSON</small></footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CENTER = { lat: 37.185, lon: -77.65 };
const HEADERS = { "Accept": "application/ld+json" };
const $ = id => document.getElementById(id);

async function getPoint() {
  const r = await fetch(`https://api.weather.gov/points/${CENTER.lat},${CENTER.lon}`, { headers: HEADERS });
  if (!r.ok) throw new Error("points " + r.status);
  return r.json();
}

async function fetchAlerts() {
  try {
    const pt = await getPoint();
    const zone = pt.properties.forecastZone.split("/").pop();
    const a = await fetch(`https://api.weather.gov/alerts/active?zone=${zone}`, { headers: HEADERS }).then(r=>r.json());
    const list = a.features.slice(0,6);
    const ul = $("alerts"); ul.innerHTML="";
    if (!list.length) { ul.innerHTML="<li>No active alerts.</li>"; return; }
    list.forEach(f=>{
      const p=f.properties;
      ul.innerHTML+=`<li><b>${p.event}</b> — ${p.severity}<br><small>${p.headline}</small></li>`;
    });
  } catch(e){ console.error(e); $("alerts").innerHTML="<li>Error loading alerts.</li>"; }
}

async function fetchObs() {
  try {
    const pt = await getPoint();
    const sUrl = pt.properties.observationStations;
    const s = await fetch(sUrl,{headers:HEADERS}).then(r=>r.json());
    const id = s.features[0].properties.stationIdentifier;
    const o = await fetch(`https://api.weather.gov/stations/${id}/observations/latest`,{headers:HEADERS}).then(r=>r.json());
    const p=o.properties;
    $("temp").textContent = p.temperature?.value!=null ? (p.temperature.value*9/5+32).toFixed(0)+" °F" : "—";
    const ws=p.windSpeed?.value,wg=p.windGust?.value;
    $("wind").textContent = ws!=null ? `${(ws*2.23694).toFixed(0)} mph${wg?` (g ${(wg*2.23694).toFixed(0)})`:''}` : "—";
    $("rh").textContent = p.relativeHumidity?.value!=null ? `${p.relativeHumidity.value.toFixed(0)} %` : "—";
    $("obsTime").textContent = p.timestamp ? new Date(p.timestamp).toLocaleString() : "—";
  } catch(e){ console.error(e); }
}

async function fetchDanger() {
  try {
    const pt = await getPoint();
    const g = await fetch(pt.properties.forecastGridData,{headers:HEADERS}).then(r=>r.json());
    const rh=g.properties.relativeHumidity.values.slice(0,12).map(v=>v.value);
    const ws=g.properties.windSpeed.values.slice(0,12).map(v=>v.value);
    const minRH=Math.min(...rh), maxWind=Math.max(...ws)*2.23694;
    let cls="Low",lvl="low";
    if (minRH<=20||(minRH<=30&&maxWind>=30)){cls="Very High (4)";lvl="vhigh";}
    else if (minRH<=30&&maxWind>=15){cls="High (3)";lvl="high";}
    else if (minRH<=40&&maxWind>=10){cls="Moderate (2)";lvl="mod";}
    $("danger").textContent=`${cls} — RH ${minRH.toFixed(0)}% / wind ${maxWind.toFixed(0)} mph`;
    $("dangerMeta").textContent=`Heuristic 30/30/30 rule applied.`;
  } catch(e){ console.error(e); $("danger").textContent="—"; }
}

// Map and GeoJSON
let map=L.map("map").setView([37.185,-77.65],9);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OSM"}).addTo(map);
fetch("assets/data/hotspots.geojson").then(r=>r.json()).then(data=>{
  L.geoJSON(data,{onEachFeature:(f,layer)=>layer.bindPopup(f.properties?.title||"Hotspot")}).addTo(map);
}).catch(e=>console.error("geojson",e));

// Run
function refreshAll(){fetchAlerts();fetchObs();fetchDanger();}
$("refreshBtn").onclick=refreshAll;
refreshAll();
setInterval(refreshAll,900000);
</script>
</body>
</html>
